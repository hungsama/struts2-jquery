/**
 * jqGrid extension for manipulating Grid Data
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
**/
(function(a){a.jgrid.inlineEdit=a.jgrid.inlineEdit||{};a.jgrid.extend({editRow:function(c,m,l,g,b,h,f,i,j){var e={keys:m||false,oneditfunc:l||null,successfunc:g||null,url:b||null,extraparam:h||{},aftersavefunc:f||null,errorfunc:i||null,afterrestorefunc:j||null,restoreAfterError:true,mtype:"POST"},k=a.makeArray(arguments).slice(1),d;if(k[0]&&typeof(k[0])=="object"&&!a.isFunction(k[0])){d=a.extend(a.jgrid.inlineEdit,e,k[0])}else{d=e}return this.each(function(){var q=this,v,r,o,p=0,u=null,t={},n,s;if(!q.grid){return}n=a(q).jqGrid("getInd",c,true);if(n===false){return}o=a(n).attr("editable")||"0";if(o=="0"&&!a(n).hasClass("not-editable-row")){s=q.p.colModel;a('td[role="gridcell"]',n).each(function(z){v=s[z].name;var y=q.p.treeGrid===true&&v==q.p.ExpandColumn;if(y){r=a("span:first",this).html()}else{try{r=a.unformat(this,{rowId:c,colModel:s[z]},z)}catch(w){r=(s[z].edittype&&s[z].edittype=="textarea")?a(this).text():a(this).html()}}if(v!="cb"&&v!="subgrid"&&v!="rn"){if(q.p.autoencode){r=a.jgrid.htmlDecode(r)}t[v]=r;if(s[z].editable===true){if(u===null){u=z}if(y){a("span:first",this).html("")}else{a(this).html("")}var x=a.extend({},s[z].editoptions||{},{id:c+"_"+v,name:v});if(!s[z].edittype){s[z].edittype="text"}if(r=="&nbsp;"||r=="&#160;"||(r.length==1&&r.charCodeAt(0)==160)){r=""}var A=a.jgrid.createEl(s[z].edittype,x,r,true,a.extend({},a.jgrid.ajaxOptions,q.p.ajaxSelectOptions||{}));a(A).addClass("editable");if(y){a("span:first",this).append(A)}else{a(this).append(A)}if(s[z].edittype=="select"&&typeof(s[z].editoptions)!=="undefined"&&s[z].editoptions.multiple===true&&typeof(s[z].editoptions.dataUrl)==="undefined"&&a.browser.msie){a(A).width(a(A).width())}p++}}});if(p>0){t.id=c;q.p.savedRow.push(t);a(n).attr("editable","1");a("td:eq("+u+") input",n).focus();if(d.keys===true){a(n).bind("keydown",function(x){if(x.keyCode===27){a(q).jqGrid("restoreRow",c,j);return false}if(x.keyCode===13){var w=x.target;if(w.tagName=="TEXTAREA"){return true}a(q).jqGrid("saveRow",c,d);return false}})}if(a.isFunction(d.oneditfunc)){d.oneditfunc.call(q,c)}}}})},saveRow:function(l,i,g,h,q,n,b){var E={successfunc:i||null,url:g||null,extraparam:h||{},aftersavefunc:q||null,errorfunc:n||null,afterrestorefunc:b||null,restoreAfterError:true,mtype:"POST"},d=a.makeArray(arguments).slice(1),z;if(d[0]&&typeof(d[0])=="object"&&!a.isFunction(d[0])){z=a.extend(a.jgrid.inlineEdit,E,d[0])}else{z=E}var m=false;var C=this[0],c,F={},y={},x={},A,j,f,t;if(!C.grid){return m}t=a(C).jqGrid("getInd",l,true);if(t===false){return m}A=a(t).attr("editable");z.url=z.url?z.url:C.p.editurl;if(A==="1"){var r;a('td[role="gridcell"]',t).each(function(o){r=C.p.colModel[o];c=r.name;if(c!="cb"&&c!="subgrid"&&r.editable===true&&c!="rn"&&!a(this).hasClass("not-editable-cell")){switch(r.edittype){case"checkbox":var k=["Yes","No"];if(r.editoptions){k=r.editoptions.value.split(":")}F[c]=a("input",this).is(":checked")?k[0]:k[1];break;case"text":case"password":case"textarea":case"button":F[c]=a("input, textarea",this).val();break;case"select":if(!r.editoptions.multiple){F[c]=a("select option:selected",this).val();y[c]=a("select option:selected",this).text()}else{var G=a("select",this),I=[];F[c]=a(G).val();if(F[c]){F[c]=F[c].join(",")}else{F[c]=""}a("select option:selected",this).each(function(e,J){I[e]=a(J).text()});y[c]=I.join(",")}if(r.formatter&&r.formatter=="select"){y={}}break;case"custom":try{if(r.editoptions&&a.isFunction(r.editoptions.custom_value)){F[c]=r.editoptions.custom_value.call(C,a(".customelement",this),"get");if(F[c]===undefined){throw"e2"}}else{throw"e1"}}catch(H){if(H=="e1"){a.jgrid.info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.nodefined,jQuery.jgrid.edit.bClose)}if(H=="e2"){a.jgrid.info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.novalue,jQuery.jgrid.edit.bClose)}else{a.jgrid.info_dialog(jQuery.jgrid.errors.errcap,H.message,jQuery.jgrid.edit.bClose)}}break}f=a.jgrid.checkValues(F[c],o,C);if(f[0]===false){f[1]=F[c]+" "+f[1];return false}if(C.p.autoencode){F[c]=a.jgrid.htmlEncode(F[c])}if(z.url!=="clientArray"&&r.editoptions&&r.editoptions.NullIfEmpty===true){if(F[c]===""){x[c]="null"}}}});if(f[0]===false){try{var p=a.jgrid.findPos(a("#"+a.jgrid.jqID(l),C.grid.bDiv)[0]);a.jgrid.info_dialog(a.jgrid.errors.errcap,f[1],a.jgrid.edit.bClose,{left:p[0],top:p[1]})}catch(D){alert(f[1])}return m}var v,s,u;s=C.p.prmNames;u=s.oper;v=s.id;if(F){F[u]=s.editoper;F[v]=l;if(typeof(C.p.inlineData)=="undefined"){C.p.inlineData={}}F=a.extend({},F,C.p.inlineData,z.extraparam)}if(z.url=="clientArray"){F=a.extend({},F,y);if(C.p.autoencode){a.each(F,function(k,e){F[k]=a.jgrid.htmlDecode(e)})}var w=a(C).jqGrid("setRowData",l,F);a(t).attr("editable","0");for(var B=0;B<C.p.savedRow.length;B++){if(C.p.savedRow[B].id==l){j=B;break}}if(j>=0){C.p.savedRow.splice(j,1)}if(a.isFunction(z.aftersavefunc)){z.aftersavefunc.call(C,l,w)}m=true;a(t).unbind("keydown")}else{a("#lui_"+C.p.id).show();x=a.extend({},F,x);x[v]=a.jgrid.stripPref(C.p.idPrefix,x[v]);a.ajax(a.extend({url:z.url,data:a.isFunction(C.p.serializeRowData)?C.p.serializeRowData.call(C,x):x,type:z.mtype,async:false,complete:function(G,H){a("#lui_"+C.p.id).hide();if(H==="success"){var o=true,I;if(a.isFunction(z.successfunc)){I=z.successfunc.call(C,G);if(a.isArray(I)){o=I[0];F=I[1]?I[1]:F}else{o=I}}if(o===true){if(C.p.autoencode){a.each(F,function(J,k){F[J]=a.jgrid.htmlDecode(k)})}F=a.extend({},F,y);a(C).jqGrid("setRowData",l,F);a(t).attr("editable","0");for(var e=0;e<C.p.savedRow.length;e++){if(C.p.savedRow[e].id==l){j=e;break}}if(j>=0){C.p.savedRow.splice(j,1)}if(a.isFunction(z.aftersavefunc)){z.aftersavefunc.call(C,l,G)}m=true;a(t).unbind("keydown")}else{if(a.isFunction(z.errorfunc)){z.errorfunc.call(C,l,G,H)}if(z.restoreAfterError===true){a(C).jqGrid("restoreRow",l,z.afterrestorefunc)}}}},error:function(k,o){a("#lui_"+C.p.id).hide();if(a.isFunction(z.errorfunc)){z.errorfunc.call(C,l,k,o)}else{try{jQuery.jgrid.info_dialog(jQuery.jgrid.errors.errcap,'<div class="ui-state-error">'+k.responseText+"</div>",jQuery.jgrid.edit.bClose,{buttonalign:"right"})}catch(G){alert(k.responseText)}}if(z.restoreAfterError===true){a(C).jqGrid("restoreRow",l,z.afterrestorefunc)}}},a.jgrid.ajaxOptions,C.p.ajaxRowOptions||{}))}}return m},restoreRow:function(e,b){var d={afterrestorefunc:b||null},c=a.makeArray(arguments).slice(1),f;if(c[0]&&typeof(c[0])=="object"&&!a.isFunction(c[0])){f=a.extend(a.jgrid.inlineEdit,d,c[0])}else{f=d}return this.each(function(){var m=this,g,i,l={};if(!m.grid){return}i=a(m).jqGrid("getInd",e,true);if(i===false){return}for(var h=0;h<m.p.savedRow.length;h++){if(m.p.savedRow[h].id==e){g=h;break}}if(g>=0){if(a.isFunction(a.fn.datepicker)){try{a("input.hasDatepicker","#"+a.jgrid.jqID(i.id)).datepicker("hide")}catch(j){}}a.each(m.p.colModel,function(k,o){if(this.editable===true&&this.name in m.p.savedRow[g]&&!a(this).hasClass("not-editable-cell")){l[this.name]=m.p.savedRow[g][this.name]}});a(m).jqGrid("setRowData",e,l);a(i).attr("editable","0").unbind("keydown");m.p.savedRow.splice(g,1);if(a("#"+a.jgrid.jqID(e),"#"+a.jgrid.jqID(m.p.id)).hasClass("jqgrid-new-row")){setTimeout(function(){a(m).jqGrid("delRowData",e)},0)}}if(a.isFunction(f.afterrestorefunc)){f.afterrestorefunc.call(m,e)}})},addRow:function(b){b=a.extend({rowID:"new_row",initdata:{},position:"first",useDefValues:false,useFormatter:false,addRowParams:{extraparam:{}}},b||{});return this.each(function(){if(!this.grid){return}var e=this;if(b.useDefValues===true){a(e.p.colModel).each(function(h){if(this.edioptions&&this.editoptions.defaultValue){var g=this.editoptions.defaultValue,f=a.isFunction(g)?g.call(e):g;b.initdata[this.name]=f}})}a(e).jqGrid("addRowData",b.rowID,b.initdata,b.position);a("#"+a.jgrid.jqID(b.rowID),"#"+a.jgrid.jqID(e.p.id)).addClass("jqgrid-new-row");if(b.useFormatter){a("#"+a.jgrid.jqID(b.rowID)+" .ui-inline-edit","#"+a.jgrid.jqID(e.p.id)).click()}else{var c=e.p.prmNames,d=c.oper;b.addRowParams.extraparam[d]=c.addoper;a(e).jqGrid("editRow",b.rowID,b.addRowParams);a(e).jqGrid("setSelection",b.rowID)}})},inlineNav:function(b,c){c=a.extend({edit:true,editicon:"ui-icon-pencil",add:true,addicon:"ui-icon-plus",save:true,saveicon:"ui-icon-disk",cancel:true,cancelicon:"ui-icon-cancel",addParams:{useFormatter:false},editParams:{}},a.jgrid.nav,c||{});return this.each(function(){if(!this.grid){return}var h=this;if(c.addParams.useFormatter===true){var d=h.p.colModel,f;for(f=0;f<d.length;f++){if(d[f].formatter&&d[f].formatter==="actions"){if(d[f].formatoptions){var g={keys:false,onEdit:null,onSuccess:null,afterSave:null,onError:null,afterRestore:null,extraparam:{},url:null},e=a.extend(g,d[f].formatoptions);c.addParams.addRowParams={keys:e.keys,oneditfunc:e.onEdit,successfunc:e.onSuccess,url:e.url,extraparam:e.extraparam,aftersavefunc:e.afterSavef,errorfunc:e.onError,afterrestorefunc:e.afterRestore}}break}}}if(c.add){a(h).jqGrid("navButtonAdd",b,{caption:c.addtext,title:c.addtitle,buttonicon:c.addicon,id:h.p.id+"_iladd",onClickButton:function(i){a(h).jqGrid("addRow",c.addParams);if(!c.addParams.useFormatter){a("#"+h.p.id+"_ilsave").removeClass("ui-state-disabled");a("#"+h.p.id+"_ilcancel").removeClass("ui-state-disabled");a("#"+h.p.id+"_iladd").addClass("ui-state-disabled");a("#"+h.p.id+"_iledit").addClass("ui-state-disabled")}}})}if(c.edit){a(h).jqGrid("navButtonAdd",b,{caption:c.edittext,title:c.edittitle,buttonicon:c.editicon,id:h.p.id+"_iledit",onClickButton:function(j){var i=a(h).jqGrid("getGridParam","selrow");if(i){a(h).jqGrid("editRow",i,c.editParams);a("#"+h.p.id+"_ilsave").removeClass("ui-state-disabled");a("#"+h.p.id+"_ilcancel").removeClass("ui-state-disabled");a("#"+h.p.id+"_iladd").addClass("ui-state-disabled");a("#"+h.p.id+"_iledit").addClass("ui-state-disabled")}else{a.jgrid.viewModal("#alertmod",{gbox:"#gbox_"+h.p.id,jqm:true});a("#jqg_alrt").focus()}}})}if(c.save){a(h).jqGrid("navButtonAdd",b,{caption:c.savetext||"",title:c.savetitle||"Save row",buttonicon:c.saveicon,id:h.p.id+"_ilsave",onClickButton:function(k){var j=a(h).jqGrid("getGridParam","selrow");if(j){if(a("#"+a.jgrid.jqID(j),"#"+a.jgrid.jqID(h.p.id)).hasClass("jqgrid-new-row")){var i=h.p.prmNames,l=i.oper;if(!c.editParams.extraparam){c.editParams.extraparam={}}c.editParams.extraparam[l]=i.addoper}a(h).jqGrid("saveRow",j,c.editParams);a("#"+h.p.id+"_ilsave").addClass("ui-state-disabled");a("#"+h.p.id+"_ilcancel").addClass("ui-state-disabled");a("#"+h.p.id+"_iladd").removeClass("ui-state-disabled");a("#"+h.p.id+"_iledit").removeClass("ui-state-disabled")}else{a.jgrid.viewModal("#alertmod",{gbox:"#gbox_"+h.p.id,jqm:true});a("#jqg_alrt").focus()}}});a("#"+h.p.id+"_ilsave").addClass("ui-state-disabled")}if(c.cancel){a(h).jqGrid("navButtonAdd",b,{caption:c.canceltext||"",title:c.canceltitle||"Cancel row editing",buttonicon:c.cancelicon,id:h.p.id+"_ilcancel",onClickButton:function(j){var i=a(h).jqGrid("getGridParam","selrow");if(i){a(h).jqGrid("restoreRow",i,c.editParams);a("#"+h.p.id+"_ilsave").addClass("ui-state-disabled");a("#"+h.p.id+"_ilcancel").addClass("ui-state-disabled");a("#"+h.p.id+"_iladd").removeClass("ui-state-disabled");a("#"+h.p.id+"_iledit").removeClass("ui-state-disabled")}else{a.jgrid.viewModal("#alertmod",{gbox:"#gbox_"+h.p.id,jqm:true});a("#jqg_alrt").focus()}}});a("#"+h.p.id+"_ilcancel").addClass("ui-state-disabled")}})}})})(jQuery);