/**
 * jqGrid extension - Tree Grid
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
**/
(function(a){a.jgrid.extend({setTreeNode:function(b,c){return this.each(function(){var h=this;if(!h.grid||!h.p.treeGrid){return}var l=h.p.expColInd,j=h.p.treeReader.expanded_field,f=h.p.treeReader.leaf_field,e=h.p.treeReader.level_field,i=h.p.treeReader.loaded;c.level=b[e];if(h.p.treeGridModel=="nested"){var o=b[h.p.treeReader.left_field],n=b[h.p.treeReader.right_field];if(!b[f]){b[f]=(parseInt(n,10)===parseInt(o,10)+1)?"true":"false"}}else{}var k=parseInt(b[e],10),g,m;if(h.p.tree_root_level===0){g=k+1;m=k}else{g=k;m=k-1}var d="<div class='tree-wrap tree-wrap-"+h.p.direction+"' style='width:"+(g*18)+"px;'>";d+="<div style='"+(h.p.direction=="rtl"?"right:":"left:")+(m*18)+"px;' class='ui-icon ";if(b[i]!=undefined){if(b[i]=="true"||b[i]===true){b[i]=true}else{b[i]=false}}if(b[f]=="true"||b[f]===true){d+=h.p.treeIcons.leaf+" tree-leaf'";b[f]=true;b[j]=false}else{if(b[j]=="true"||b[j]===true){d+=h.p.treeIcons.minus+" tree-minus treeclick'";b[j]=true}else{d+=h.p.treeIcons.plus+" tree-plus treeclick'";b[j]=false}b[f]=false}d+="</div></div>";if(!h.p.loadonce){b[h.p.localReader.id]=c.id;h.p.data.push(b);h.p._index[c.id]=h.p.data.length-1}if(parseInt(b[e],10)!==parseInt(h.p.tree_root_level,10)){if(!a(h).jqGrid("isVisibleNode",b)){a(c).css("display","none")}}a("td:eq("+l+")",c).wrapInner("<span></span>").prepend(d);a(".treeclick",c).bind("click",function(s){var r=s.target||s.srcElement,u=a(r,h.rows).closest("tr.jqgrow")[0].id,t=h.p._index[u],q=h.p.treeReader.leaf_field,p=h.p.treeReader.expanded_field;if(!h.p.data[t][q]){if(h.p.data[t][p]){a(h).jqGrid("collapseRow",h.p.data[t]);a(h).jqGrid("collapseNode",h.p.data[t])}else{a(h).jqGrid("expandRow",h.p.data[t]);a(h).jqGrid("expandNode",h.p.data[t])}}return false});if(h.p.ExpandColClick===true){a("span",c).css("cursor","pointer").bind("click",function(s){var r=s.target||s.srcElement,u=a(r,h.rows).closest("tr.jqgrow")[0].id,t=h.p._index[u],q=h.p.treeReader.leaf_field,p=h.p.treeReader.expanded_field;if(!h.p.data[t][q]){if(h.p.data[t][p]){a(h).jqGrid("collapseRow",h.p.data[t]);a(h).jqGrid("collapseNode",h.p.data[t])}else{a(h).jqGrid("expandRow",h.p.data[t]);a(h).jqGrid("expandNode",h.p.data[t])}}a(h).jqGrid("setSelection",u);return false})}})},setTreeGrid:function(){return this.each(function(){var e=this,d=0,b;if(!e.p.treeGrid){return}if(!e.p.treedatatype){a.extend(e.p,{treedatatype:e.p.datatype})}e.p.subGrid=false;e.p.altRows=false;e.p.pgbuttons=false;e.p.pginput=false;e.p.multiselect=false;e.p.rowList=[];b="ui-icon-triangle-1-"+(e.p.direction=="rtl"?"w":"e");e.p.treeIcons=a.extend({plus:b,minus:"ui-icon-triangle-1-s",leaf:"ui-icon-radio-off"},e.p.treeIcons||{});if(e.p.treeGridModel=="nested"){e.p.treeReader=a.extend({level_field:"level",left_field:"lft",right_field:"rgt",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded"},e.p.treeReader)}else{if(e.p.treeGridModel=="adjacency"){e.p.treeReader=a.extend({level_field:"level",parent_id_field:"parent",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded"},e.p.treeReader)}}for(var c in e.p.colModel){if(e.p.colModel.hasOwnProperty(c)){if(e.p.colModel[c].name==e.p.ExpandColumn){e.p.expColInd=d;break}d++}}if(!e.p.expColInd){e.p.expColInd=0}a.each(e.p.treeReader,function(f,g){if(g){e.p.colNames.push(g);e.p.colModel.push({name:g,width:1,hidden:true,sortable:false,resizable:false,hidedlg:true,editable:true,search:false})}})})},expandRow:function(b){this.each(function(){var e=this;if(!e.grid||!e.p.treeGrid){return}var d=a(e).jqGrid("getNodeChildren",b),c=e.p.treeReader.expanded_field;a(d).each(function(f){var g=a.jgrid.getAccessor(this,e.p.localReader.id);a("#"+g,e.grid.bDiv).css("display","");if(this[c]){a(e).jqGrid("expandRow",this)}})})},collapseRow:function(b){this.each(function(){var e=this;if(!e.grid||!e.p.treeGrid){return}var d=a(e).jqGrid("getNodeChildren",b),c=e.p.treeReader.expanded_field;a(d).each(function(f){var g=a.jgrid.getAccessor(this,e.p.localReader.id);a("#"+g,e.grid.bDiv).css("display","none");if(this[c]){a(e).jqGrid("collapseRow",this)}})})},getRootNodes:function(){var b=[];this.each(function(){var e=this;if(!e.grid||!e.p.treeGrid){return}switch(e.p.treeGridModel){case"nested":var d=e.p.treeReader.level_field;a(e.p.data).each(function(f){if(parseInt(this[d],10)===parseInt(e.p.tree_root_level,10)){b.push(this)}});break;case"adjacency":var c=e.p.treeReader.parent_id_field;a(e.p.data).each(function(f){if(this[c]===null||String(this[c]).toLowerCase()=="null"){b.push(this)}});break}});return b},getNodeDepth:function(c){var b=null;this.each(function(){if(!this.grid||!this.p.treeGrid){return}var e=this;switch(e.p.treeGridModel){case"nested":var d=e.p.treeReader.level_field;b=parseInt(c[d],10)-parseInt(e.p.tree_root_level,10);break;case"adjacency":b=a(e).jqGrid("getNodeAncestors",c).length;break}});return b},getNodeParent:function(c){var b=null;this.each(function(){var g=this;if(!g.grid||!g.p.treeGrid){return}switch(g.p.treeGridModel){case"nested":var f=g.p.treeReader.left_field,l=g.p.treeReader.right_field,h=g.p.treeReader.level_field,k=parseInt(c[f],10),j=parseInt(c[l],10),d=parseInt(c[h],10);a(this.p.data).each(function(){if(parseInt(this[h],10)===d-1&&parseInt(this[f],10)<k&&parseInt(this[l],10)>j){b=this;return false}});break;case"adjacency":var i=g.p.treeReader.parent_id_field,e=g.p.localReader.id;a(this.p.data).each(function(m,n){if(this[e]==c[i]){b=this;return false}});break}});return b},getNodeChildren:function(c){var b=[];this.each(function(){var g=this;if(!g.grid||!g.p.treeGrid){return}switch(g.p.treeGridModel){case"nested":var f=g.p.treeReader.left_field,l=g.p.treeReader.right_field,h=g.p.treeReader.level_field,k=parseInt(c[f],10),j=parseInt(c[l],10),d=parseInt(c[h],10);a(this.p.data).each(function(m){if(parseInt(this[h],10)===d+1&&parseInt(this[f],10)>k&&parseInt(this[l],10)<j){b.push(this)}});break;case"adjacency":var i=g.p.treeReader.parent_id_field,e=g.p.localReader.id;a(this.p.data).each(function(m,n){if(this[i]==c[e]){b.push(this)}});break}});return b},getFullTreeNode:function(c){var b=[];this.each(function(){var g=this,h;if(!g.grid||!g.p.treeGrid){return}switch(g.p.treeGridModel){case"nested":var f=g.p.treeReader.left_field,m=g.p.treeReader.right_field,i=g.p.treeReader.level_field,l=parseInt(c[f],10),k=parseInt(c[m],10),d=parseInt(c[i],10);a(this.p.data).each(function(n){if(parseInt(this[i],10)>=d&&parseInt(this[f],10)>=l&&parseInt(this[f],10)<=k){b.push(this)}});break;case"adjacency":b.push(c);var j=g.p.treeReader.parent_id_field,e=g.p.localReader.id;a(this.p.data).each(function(n){h=b.length;for(n=0;n<h;n++){if(b[n][e]==this[j]){b.push(this);break}}});break}});return b},getNodeAncestors:function(c){var b=[];this.each(function(){if(!this.grid||!this.p.treeGrid){return}var d=a(this).jqGrid("getNodeParent",c);while(d){b.push(d);d=a(this).jqGrid("getNodeParent",d)}});return b},isVisibleNode:function(c){var b=true;this.each(function(){var f=this;if(!f.grid||!f.p.treeGrid){return}var e=a(f).jqGrid("getNodeAncestors",c),d=f.p.treeReader.expanded_field;a(e).each(function(){b=b&&this[d];if(!b){return false}})});return b},isNodeLoaded:function(c){var b;this.each(function(){var e=this;if(!e.grid||!e.p.treeGrid){return}var d=e.p.treeReader.leaf_field;if(c.loaded!==undefined){b=c.loaded}else{if(c[d]||a(e).jqGrid("getNodeChildren",c).length>0){b=true}else{b=false}}});return b},expandNode:function(b){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var e=this.p.treeReader.expanded_field;if(!b[e]){var f=a.jgrid.getAccessor(b,this.p.localReader.id);var d=a("#"+f,this.grid.bDiv)[0];var c=this.p._index[f];if(a(this).jqGrid("isNodeLoaded",this.p.data[c])){b[e]=true;a("div.treeclick",d).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus")}else{b[e]=true;a("div.treeclick",d).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus");this.p.treeANode=d.rowIndex;this.p.datatype=this.p.treedatatype;if(this.p.treeGridModel=="nested"){a(this).jqGrid("setGridParam",{postData:{nodeid:f,n_left:b.lft,n_right:b.rgt,n_level:b.level}})}else{a(this).jqGrid("setGridParam",{postData:{nodeid:f,parentid:b.parent_id,n_level:b.level}})}a(this).trigger("reloadGrid");if(this.p.treeGridModel=="nested"){a(this).jqGrid("setGridParam",{postData:{nodeid:"",n_left:"",n_right:"",n_level:""}})}else{a(this).jqGrid("setGridParam",{postData:{nodeid:"",parentid:"",n_level:""}})}}}})},collapseNode:function(b){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}if(b.expanded){b.expanded=false;var d=a.jgrid.getAccessor(b,this.p.localReader.id);var c=a("#"+d,this.grid.bDiv)[0];a("div.treeclick",c).removeClass(this.p.treeIcons.minus+" tree-minus").addClass(this.p.treeIcons.plus+" tree-plus")}})},SortTree:function(e,c,b,d){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var k,f,m,j=[],n=this,l,h,g=a(this).jqGrid("getRootNodes");l=a.jgrid.from(g);l.orderBy(e,c,b,d);h=l.select();for(k=0,f=h.length;k<f;k++){m=h[k];j.push(m);a(this).jqGrid("collectChildrenSortTree",j,m,e,c,b,d)}a.each(j,function(i,o){var p=a.jgrid.getAccessor(this,n.p.localReader.id);a("#"+n.p.id+" tbody tr:eq("+i+")").after(a("tr#"+p,n.grid.bDiv))});l=null;h=null;j=null})},collectChildrenSortTree:function(b,f,g,d,c,e){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var k,h,n,l,m,j;l=a(this).jqGrid("getNodeChildren",f);m=a.jgrid.from(l);m.orderBy(g,d,c,e);j=m.select();for(k=0,h=j.length;k<h;k++){n=j[k];b.push(n);a(this).jqGrid("collectChildrenSortTree",b,n,g,d,c,e)}})},setTreeRow:function(b,c){var d=false;this.each(function(){var e=this;if(!e.grid||!e.p.treeGrid){return}d=a(e).jqGrid("setRowData",b,c)});return d},delTreeNode:function(b){return this.each(function(){var f=this;if(!f.grid||!f.p.treeGrid){return}var d=a(f).jqGrid("getInd",b,true);if(d){var e=a(f).jqGrid("getNodeChildren",d);if(e.length>0){for(var c=0;c<e.length;c++){a(f).jqGrid("delRowData",e[c].id)}}a(f).jqGrid("delRowData",d.id)}})}})})(jQuery);