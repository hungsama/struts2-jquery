/**
 * jqGrid extension for SubGrid Data
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/ 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
**/
	(function(a){a.jgrid.extend({setSubGrid:function(){return this.each(function(){var d=this,b;d.p.colNames.unshift("");d.p.colModel.unshift({name:"subgrid",width:a.browser.safari?d.p.subGridWidth+d.p.cellLayout:d.p.subGridWidth,sortable:false,resizable:false,hidedlg:true,search:false,fixed:true});b=d.p.subGridModel;if(b[0]){b[0].align=a.extend([],b[0].align||[]);for(var c=0;c<b[0].name.length;c++){b[0].align[c]=b[0].align[c]||"left"}}})},addSubGridCell:function(f,d){var c="",e,b;this.each(function(){c=this.formatCol(f,d);e=this.p.gridview;b=this.p.id});if(e===false){return'<td role="grid" aria-describedby="'+b+'_subgrid" class="ui-sgcollapsed sgcollapsed" '+c+"><a href='javascript:void(0);'><span class='ui-icon ui-icon-plus'></span></a></td>"}else{return'<td role="grid" aria-describedby="'+b+'_subgrid" '+c+"></td>"}},addSubGrid:function(b,c){return this.each(function(){var l=this;if(!l.grid){return}var m,n,o,i,j,g,h;a("td:eq("+c+")",b).click(function(p){if(a(this).hasClass("sgcollapsed")){o=l.p.id;m=a(this).parent();i=c>=1?"<td colspan='"+c+"'>&#160;</td>":"";n=a(m).attr("id");h=true;if(a.isFunction(l.p.subGridBeforeExpand)){h=l.p.subGridBeforeExpand(o+"_"+n,n)}if(h===false){return false}j=0;a.each(l.p.colModel,function(r,q){if(this.hidden===true||this.name=="rn"||this.name=="cb"){j++}});g="<tr role='row' class='ui-subgrid'>"+i+"<td class='ui-widget-content subgrid-cell'><span class='ui-icon ui-icon-carat-1-sw'/></td><td colspan='"+parseInt(l.p.colNames.length-1-j,10)+"' class='ui-widget-content subgrid-data'><div id="+o+"_"+n+" class='tablediv'>";a(this).parent().after(g+"</div></td></tr>");if(a.isFunction(l.p.subGridRowExpanded)){l.p.subGridRowExpanded(o+"_"+n,n)}else{k(m)}a(this).html("<a href='javascript:void(0);'><span class='ui-icon ui-icon-minus'></span></a>").removeClass("sgcollapsed").addClass("sgexpanded")}else{if(a(this).hasClass("sgexpanded")){h=true;if(a.isFunction(l.p.subGridRowColapsed)){m=a(this).parent();n=a(m).attr("id");h=l.p.subGridRowColapsed(o+"_"+n,n)}if(h===false){return false}a(this).parent().next().remove(".ui-subgrid");a(this).html("<a href='javascript:void(0);'><span class='ui-icon ui-icon-plus'></span></a>").removeClass("sgexpanded").addClass("sgcollapsed")}}return false});var k=function(t){var s,p,u,r,q;p=a(t).attr("id");u={nd_:(new Date().getTime())};u[l.p.prmNames.subgridid]=p;if(!l.p.subGridModel[0]){return false}if(l.p.subGridModel[0].params){for(q=0;q<l.p.subGridModel[0].params.length;q++){for(r=0;r<l.p.colModel.length;r++){if(l.p.colModel[r].name==l.p.subGridModel[0].params[q]){u[l.p.colModel[r].name]=a("td:eq("+r+")",t).text().replace(/\&#160\;/ig,"")}}}}if(!l.grid.hDiv.loading){l.grid.hDiv.loading=true;a("#load_"+l.p.id).show();if(!l.p.subgridtype){l.p.subgridtype=l.p.datatype}if(a.isFunction(l.p.subgridtype)){l.p.subgridtype(u)}else{l.p.subgridtype=l.p.subgridtype.toLowerCase()}switch(l.p.subgridtype){case"xml":case"json":a.ajax(a.extend({type:l.p.mtype,url:l.p.subGridUrl,dataType:l.p.subgridtype,data:a.isFunction(l.p.serializeSubGridData)?l.p.serializeSubGridData(u):u,complete:function(v){if(l.p.subgridtype=="xml"){d(v.responseXML,p)}else{f(a.jgrid.parse(v.responseText),p)}v=null}},a.jgrid.ajaxOptions,l.p.ajaxSubgridOptions||{}));break}}return false};var e=function(q,p,s){var r=a("<td align='"+l.p.subGridModel[0].align[s]+"'></td>").html(p);a(q).append(r)};var d=function(u,s){var w,t,v,p,r=a("<table cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>"),q=a("<tr></tr>");for(t=0;t<l.p.subGridModel[0].name.length;t++){w=a("<th class='ui-state-default ui-th-subgrid ui-th-column ui-th-"+l.p.direction+"'></th>");a(w).html(l.p.subGridModel[0].name[t]);a(w).width(l.p.subGridModel[0].width[t]);a(q).append(w)}a(r).append(q);if(u){p=l.p.xmlReader.subgrid;a(p.root+" "+p.row,u).each(function(){q=a("<tr class='ui-widget-content ui-subtblcell'></tr>");if(p.repeatitems===true){a(p.cell,this).each(function(z){e(q,a(this).text()||"&#160;",z)})}else{var y=l.p.subGridModel[0].mapping||l.p.subGridModel[0].name;if(y){for(t=0;t<y.length;t++){e(q,a(y[t],this).text()||"&#160;",t)}}}a(r).append(q)})}var x=a("table:first",l.grid.bDiv).attr("id")+"_";a("#"+x+s).append(r);l.grid.hDiv.loading=false;a("#load_"+l.p.id).hide();return false};var f=function(w,t){var y,A,u,x,p,s,r=a("<table cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>"),q=a("<tr></tr>");for(u=0;u<l.p.subGridModel[0].name.length;u++){y=a("<th class='ui-state-default ui-th-subgrid ui-th-column ui-th-"+l.p.direction+"'></th>");a(y).html(l.p.subGridModel[0].name[u]);a(y).width(l.p.subGridModel[0].width[u]);a(q).append(y)}a(r).append(q);if(w){p=l.p.jsonReader.subgrid;A=w[p.root];if(typeof A!=="undefined"){for(u=0;u<A.length;u++){x=A[u];q=a("<tr class='ui-widget-content ui-subtblcell'></tr>");if(p.repeatitems===true){if(p.cell){x=x[p.cell]}for(s=0;s<x.length;s++){e(q,x[s]||"&#160;",s)}}else{var v=l.p.subGridModel[0].mapping||l.p.subGridModel[0].name;if(v.length){for(s=0;s<v.length;s++){e(q,x[v[s]]||"&#160;",s)}}}a(r).append(q)}}}var z=a("table:first",l.grid.bDiv).attr("id")+"_";a("#"+z+t).append(r);l.grid.hDiv.loading=false;a("#load_"+l.p.id).hide();return false};l.subGridXml=function(q,p){d(q,p)};l.subGridJson=function(q,p){f(q,p)}})},expandSubGridRow:function(b){return this.each(function(){var e=this;if(!e.grid&&!b){return}if(e.p.subGrid===true){var c=a(this).jqGrid("getInd",b,true);if(c){var d=a("td.sgcollapsed",c)[0];if(d){a(d).trigger("click")}}}})},collapseSubGridRow:function(b){return this.each(function(){var e=this;if(!e.grid&&!b){return}if(e.p.subGrid===true){var c=a(this).jqGrid("getInd",b,true);if(c){var d=a("td.sgexpanded",c)[0];if(d){a(d).trigger("click")}}}})},toggleSubGridRow:function(b){return this.each(function(){var e=this;if(!e.grid&&!b){return}if(e.p.subGrid===true){var c=a(this).jqGrid("getInd",b,true);if(c){var d=a("td.sgcollapsed",c)[0];if(d){a(d).trigger("click")}else{d=a("td.sgexpanded",c)[0];if(d){a(d).trigger("click")}}}}})}})})(jQuery);