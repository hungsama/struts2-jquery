/**
 * jqGrid extension for manipulating Grid Data
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/ 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
**/ 
(function(a){a.jgrid.extend({editRow:function(c,i,h,j,b,e,d,f,g){return this.each(function(){var n=this,s,o,l,m=0,r=null,q={},k,p;if(!n.grid){return}k=a(n).jqGrid("getInd",c,true);if(k===false){return}l=a(k).attr("editable")||"0";if(l=="0"&&!a(k).hasClass("not-editable-row")){p=n.p.colModel;a("td",k).each(function(w){s=p[w].name;var v=n.p.treeGrid===true&&s==n.p.ExpandColumn;if(v){o=a("span:first",this).html()}else{try{o=a.unformat(this,{rowId:c,colModel:p[w]},w)}catch(t){o=a(this).html()}}if(s!="cb"&&s!="subgrid"&&s!="rn"){if(n.p.autoencode){o=a.jgrid.htmlDecode(o)}q[s]=o;if(p[w].editable===true){if(r===null){r=w}if(v){a("span:first",this).html("")}else{a(this).html("")}var u=a.extend({},p[w].editoptions||{},{id:c+"_"+s,name:s});if(!p[w].edittype){p[w].edittype="text"}var x=createEl(p[w].edittype,u,o,true,a.extend({},a.jgrid.ajaxOptions,n.p.ajaxSelectOptions||{}));a(x).addClass("editable");if(v){a("span:first",this).append(x)}else{a(this).append(x)}if(p[w].edittype=="select"&&p[w].editoptions.multiple===true&&a.browser.msie){a(x).width(a(x).width())}m++}}});if(m>0){q.id=c;n.p.savedRow.push(q);a(k).attr("editable","1");a("td:eq("+r+") input",k).focus();if(i===true){a(k).bind("keydown",function(u){if(u.keyCode===27){a(n).jqGrid("restoreRow",c,g)}if(u.keyCode===13){var t=u.target;if(t.tagName=="TEXTAREA"){return true}a(n).jqGrid("saveRow",c,j,b,e,d,f,g);return false}u.stopPropagation()})}if(a.isFunction(h)){h(c)}}}})},saveRow:function(h,g,e,f,d,c,b){return this.each(function(){var r=this,y,s={},m={},j,u,t,i;if(!r.grid){return}i=a(r).jqGrid("getInd",h,true);if(i===false){return}j=a(i).attr("editable");e=e?e:r.p.editurl;if(j==="1"){var x;a("td",i).each(function(z){x=r.p.colModel[z];y=x.name;if(y!="cb"&&y!="subgrid"&&x.editable===true&&y!="rn"){switch(x.edittype){case"checkbox":var k=["Yes","No"];if(x.editoptions){k=x.editoptions.value.split(":")}s[y]=a("input",this).attr("checked")?k[0]:k[1];break;case"text":case"password":case"textarea":case"button":s[y]=a("input, textarea",this).val();break;case"select":if(!x.editoptions.multiple){s[y]=a("select>option:selected",this).val();m[y]=a("select>option:selected",this).text()}else{var A=a("select",this),C=[];s[y]=a(A).val();if(s[y]){s[y]=s[y].join(",")}else{s[y]=""}a("select > option:selected",this).each(function(D,E){C[D]=a(E).text()});m[y]=C.join(",")}if(x.formatter&&x.formatter=="select"){m={}}break;case"custom":try{if(x.editoptions&&a.isFunction(x.editoptions.custom_value)){s[y]=x.editoptions.custom_value(a(".customelement",this),"get");if(s[y]===undefined){throw"e2"}}else{throw"e1"}}catch(B){if(B=="e1"){info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.nodefined,jQuery.jgrid.edit.bClose)}if(B=="e2"){info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.novalue,jQuery.jgrid.edit.bClose)}else{info_dialog(jQuery.jgrid.errors.errcap,B.message,jQuery.jgrid.edit.bClose)}}break}t=checkValues(s[y],z,r);if(t[0]===false){t[1]=s[y]+" "+t[1];return false}if(r.p.autoencode){s[y]=a.jgrid.htmlEncode(s[y])}}});if(t[0]===false){try{var q=findPos(a("#"+a.jgrid.jqID(h),r.grid.bDiv)[0]);info_dialog(a.jgrid.errors.errcap,t[1],a.jgrid.edit.bClose,{left:q[0],top:q[1]})}catch(w){alert(t[1])}return}if(s){var v,p,l;p=r.p.prmNames;l=p.oper;v=p.id;s[l]=p.editoper;s[v]=h;if(typeof(r.p.inlineData)=="undefined"){r.p.inlineData={}}if(typeof(f)=="undefined"){f={}}s=a.extend({},s,r.p.inlineData,f)}if(e=="clientArray"){s=a.extend({},s,m);if(r.p.autoencode){a.each(s,function(z,k){s[z]=a.jgrid.htmlDecode(k)})}var o=a(r).jqGrid("setRowData",h,s);a(i).attr("editable","0");for(var n=0;n<r.p.savedRow.length;n++){if(r.p.savedRow[n].id==h){u=n;break}}if(u>=0){r.p.savedRow.splice(u,1)}if(a.isFunction(d)){d(h,o)}}else{a("#lui_"+r.p.id).show();a.ajax(a.extend({url:e,data:a.isFunction(r.p.serializeRowData)?r.p.serializeRowData(s):s,type:"POST",complete:function(B,C){a("#lui_"+r.p.id).hide();if(C==="success"){var A;if(a.isFunction(g)){A=g(B)}else{A=true}if(A===true){if(r.p.autoencode){a.each(s,function(D,k){s[D]=a.jgrid.htmlDecode(k)})}s=a.extend({},s,m);a(r).jqGrid("setRowData",h,s);a(i).attr("editable","0");for(var z=0;z<r.p.savedRow.length;z++){if(r.p.savedRow[z].id==h){u=z;break}}if(u>=0){r.p.savedRow.splice(u,1)}if(a.isFunction(d)){d(h,B)}}else{a(r).jqGrid("restoreRow",h,b)}}},error:function(k,z){a("#lui_"+r.p.id).hide();if(a.isFunction(c)){c(h,k,z)}else{alert("Error Row: "+h+" Result: "+k.status+":"+k.statusText+" Status: "+z)}a(r).jqGrid("restoreRow",h,b)}},a.jgrid.ajaxOptions,r.p.ajaxRowOptions||{}))}a(i).unbind("keydown")}})},restoreRow:function(c,b){return this.each(function(){var j=this,d,g,i={};if(!j.grid){return}g=a(j).jqGrid("getInd",c,true);if(g===false){return}for(var f=0;f<j.p.savedRow.length;f++){if(j.p.savedRow[f].id==c){d=f;break}}if(d>=0){if(a.isFunction(a.fn.datepicker)){try{a("input.hasDatepicker","#"+a.jgrid.jqID(g.id)).datepicker("hide")}catch(h){}}a.each(j.p.colModel,function(e,k){if(this.editable===true&&this.name in j.p.savedRow[d]){i[this.name]=j.p.savedRow[d][this.name]}});a(j).jqGrid("setRowData",c,i);a(g).attr("editable","0").unbind("keydown");j.p.savedRow.splice(d,1)}if(a.isFunction(b)){b(c)}})}})})(jQuery);