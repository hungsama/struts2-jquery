/**
 * jqGrid extension for manipulating Grid Data
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
**/
(function(a){a.jgrid.extend({editRow:function(c,l,k,m,b,g,f,h,i){var e={keys:l||false,oneditfunc:k||null,successfunc:m||null,url:b||null,extraparam:g||{},aftersavefunc:f||null,errorfunc:h||null,afterrestorefunc:i||null,restoreAfterErorr:true},j=a.makeArray(arguments).slice(1),d;if(j[0]&&typeof(j[0])=="object"&&!a.isFunction(j[0])){d=a.extend(e,j[0])}else{d=e}return this.each(function(){var q=this,v,r,o,p=0,u=null,t={},n,s;if(!q.grid){return}n=a(q).jqGrid("getInd",c,true);if(n===false){return}o=a(n).attr("editable")||"0";if(o=="0"&&!a(n).hasClass("not-editable-row")){s=q.p.colModel;a("td",n).each(function(z){v=s[z].name;var y=q.p.treeGrid===true&&v==q.p.ExpandColumn;if(y){r=a("span:first",this).html()}else{try{r=a.unformat(this,{rowId:c,colModel:s[z]},z)}catch(w){r=a(this).html()}}if(v!="cb"&&v!="subgrid"&&v!="rn"){if(q.p.autoencode){r=a.jgrid.htmlDecode(r)}t[v]=r;if(s[z].editable===true){if(u===null){u=z}if(y){a("span:first",this).html("")}else{a(this).html("")}var x=a.extend({},s[z].editoptions||{},{id:c+"_"+v,name:v});if(!s[z].edittype){s[z].edittype="text"}var A=a.jgrid.createEl(s[z].edittype,x,r,true,a.extend({},a.jgrid.ajaxOptions,q.p.ajaxSelectOptions||{}));a(A).addClass("editable");if(y){a("span:first",this).append(A)}else{a(this).append(A)}if(s[z].edittype=="select"&&s[z].editoptions.multiple===true&&a.browser.msie){a(A).width(a(A).width())}p++}}});if(p>0){t.id=c;q.p.savedRow.push(t);a(n).attr("editable","1");a("td:eq("+u+") input",n).focus();if(d.keys===true){a(n).bind("keydown",function(x){if(x.keyCode===27){a(q).jqGrid("restoreRow",c,i)}if(x.keyCode===13){var w=x.target;if(w.tagName=="TEXTAREA"){return true}a(q).jqGrid("saveRow",c,d);return false}x.stopPropagation()})}if(a.isFunction(d.oneditfunc)){d.oneditfunc.call(q,c)}}}})},saveRow:function(j,F,g,h,p,m,b){var D={successfunc:F||null,url:g||null,extraparam:h||{},aftersavefunc:p||null,errorfunc:m||null,afterrestorefunc:b||null,restoreAfterErorr:true},d=a.makeArray(arguments).slice(1),y;if(d[0]&&typeof(d[0])=="object"&&!a.isFunction(d[0])){y=a.extend(D,d[0])}else{y=D}var l=false;var B=this[0],c,E={},x={},w={},z,i,f,s;if(!B.grid){return l}s=a(B).jqGrid("getInd",j,true);if(s===false){return l}z=a(s).attr("editable");y.url=y.url?y.url:B.p.editurl;if(z==="1"){var q;a("td",s).each(function(o){q=B.p.colModel[o];c=q.name;if(c!="cb"&&c!="subgrid"&&q.editable===true&&c!="rn"&&!a(this).hasClass("not-editable-cell")){switch(q.edittype){case"checkbox":var k=["Yes","No"];if(q.editoptions){k=q.editoptions.value.split(":")}E[c]=a("input",this).attr("checked")?k[0]:k[1];break;case"text":case"password":case"textarea":case"button":E[c]=a("input, textarea",this).val();break;case"select":if(!q.editoptions.multiple){E[c]=a("select>option:selected",this).val();x[c]=a("select>option:selected",this).text()}else{var G=a("select",this),I=[];E[c]=a(G).val();if(E[c]){E[c]=E[c].join(",")}else{E[c]=""}a("select > option:selected",this).each(function(e,J){I[e]=a(J).text()});x[c]=I.join(",")}if(q.formatter&&q.formatter=="select"){x={}}break;case"custom":try{if(q.editoptions&&a.isFunction(q.editoptions.custom_value)){E[c]=q.editoptions.custom_value.call(B,a(".customelement",this),"get");if(E[c]===undefined){throw"e2"}}else{throw"e1"}}catch(H){if(H=="e1"){a.jgrid.info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.nodefined,jQuery.jgrid.edit.bClose)}if(H=="e2"){a.jgrid.info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.novalue,jQuery.jgrid.edit.bClose)}else{a.jgrid.info_dialog(jQuery.jgrid.errors.errcap,H.message,jQuery.jgrid.edit.bClose)}}break}f=a.jgrid.checkValues(E[c],o,B);if(f[0]===false){f[1]=E[c]+" "+f[1];return false}if(B.p.autoencode){E[c]=a.jgrid.htmlEncode(E[c])}if(y.url!=="clientArray"&&q.editoptions&&q.editoptions.NullIfEmpty===true){if(E[c]==""){w[c]="null"}}}});if(f[0]===false){try{var n=a.jgrid.findPos(a("#"+a.jgrid.jqID(j),B.grid.bDiv)[0]);a.jgrid.info_dialog(a.jgrid.errors.errcap,f[1],a.jgrid.edit.bClose,{left:n[0],top:n[1]})}catch(C){alert(f[1])}return l}if(E){var u,r,t;r=B.p.prmNames;t=r.oper;u=r.id;E[t]=r.editoper;E[u]=j;if(typeof(B.p.inlineData)=="undefined"){B.p.inlineData={}}E=a.extend({},E,B.p.inlineData,y.extraparam)}if(y.url=="clientArray"){E=a.extend({},E,x);if(B.p.autoencode){a.each(E,function(k,e){E[k]=a.jgrid.htmlDecode(e)})}var v=a(B).jqGrid("setRowData",j,E);a(s).attr("editable","0");for(var A=0;A<B.p.savedRow.length;A++){if(B.p.savedRow[A].id==j){i=A;break}}if(i>=0){B.p.savedRow.splice(i,1)}if(a.isFunction(y.aftersavefunc)){y.aftersavefunc.call(B,j,v)}l=true}else{a("#lui_"+B.p.id).show();w=a.extend({},E,w);a.ajax(a.extend({url:y.url,data:a.isFunction(B.p.serializeRowData)?B.p.serializeRowData.call(B,w):w,type:"POST",async:false,complete:function(G,H){a("#lui_"+B.p.id).hide();if(H==="success"){var o;if(a.isFunction(y.succesfunc)){o=y.succesfunc.call(B,G)}else{o=true}if(o===true){if(B.p.autoencode){a.each(E,function(I,k){E[I]=a.jgrid.htmlDecode(k)})}E=a.extend({},E,x);a(B).jqGrid("setRowData",j,E);a(s).attr("editable","0");for(var e=0;e<B.p.savedRow.length;e++){if(B.p.savedRow[e].id==j){i=e;break}}if(i>=0){B.p.savedRow.splice(i,1)}if(a.isFunction(y.aftersavefunc)){y.aftersavefunc.call(B,j,G)}l=true}else{if(a.isFunction(y.errorfunc)){y.errorfunc.call(B,j,G,H)}if(y.restoreAfterError===true){a(B).jqGrid("restoreRow",j,y.afterrestorefunc)}}}},error:function(k,o){a("#lui_"+B.p.id).hide();if(a.isFunction(y.errorfunc)){y.errorfunc.call(B,j,k,o)}else{try{jQuery.jgrid.info_dialog(jQuery.jgrid.errors.errcap,'<div class="ui-state-error">'+k.responseText+"</div>",jQuery.jgrid.edit.bClose,{buttonalign:"right"})}catch(G){alert(k.responseText)}}if(y.restoreAfterError===true){a(B).jqGrid("restoreRow",j,y.afterrestorefunc)}}},a.jgrid.ajaxOptions,B.p.ajaxRowOptions||{}))}a(s).unbind("keydown")}return l},restoreRow:function(c,b){return this.each(function(){var j=this,d,g,i={};if(!j.grid){return}g=a(j).jqGrid("getInd",c,true);if(g===false){return}for(var f=0;f<j.p.savedRow.length;f++){if(j.p.savedRow[f].id==c){d=f;break}}if(d>=0){if(a.isFunction(a.fn.datepicker)){try{a("input.hasDatepicker","#"+a.jgrid.jqID(g.id)).datepicker("hide")}catch(h){}}a.each(j.p.colModel,function(e,k){if(this.editable===true&&this.name in j.p.savedRow[d]&&!a(this).hasClass("not-editable-cell")){i[this.name]=j.p.savedRow[d][this.name]}});a(j).jqGrid("setRowData",c,i);a(g).attr("editable","0").unbind("keydown");j.p.savedRow.splice(d,1)}if(a.isFunction(b)){b.call(j,c)}})}})})(jQuery);