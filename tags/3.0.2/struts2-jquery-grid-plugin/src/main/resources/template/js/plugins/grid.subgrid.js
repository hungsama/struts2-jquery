/**
 * jqGrid extension for SubGrid Data
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
**/
(function(a){a.jgrid.extend({setSubGrid:function(){return this.each(function(){var e=this,b,c={plusicon:"ui-icon-plus",minusicon:"ui-icon-minus",openicon:"ui-icon-carat-1-sw",expandOnLoad:false,delayOnLoad:50,selectOnExpand:false,reloadOnExpand:true};e.p.subGridOptions=a.extend(c,e.p.subGridOptions||{});e.p.colNames.unshift("");e.p.colModel.unshift({name:"subgrid",width:a.browser.safari?e.p.subGridWidth+e.p.cellLayout:e.p.subGridWidth,sortable:false,resizable:false,hidedlg:true,search:false,fixed:true});b=e.p.subGridModel;if(b[0]){b[0].align=a.extend([],b[0].align||[]);for(var d=0;d<b[0].name.length;d++){b[0].align[d]=b[0].align[d]||"left"}}})},addSubGridCell:function(f,e){var d="",b,c;this.each(function(){d=this.formatCol(f,e);c=this.p.id;b=this.p.subGridOptions.plusicon});return'<td role="grid" aria-describedby="'+c+'_subgrid" class="ui-sgcollapsed sgcollapsed" '+d+"><a href='javascript:void(0);'><span class='ui-icon "+b+"'></span></a></td>"},addSubGrid:function(b){return this.each(function(){var j=this;if(!j.grid){return}var e=function(o,n,q){var p=a("<td align='"+j.p.subGridModel[0].align[q]+"'></td>").html(n);a(o).append(p)};var d=function(o,u){var t,r,q,s=a("<table cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>"),n=a("<tr></tr>");for(r=0;r<j.p.subGridModel[0].name.length;r++){t=a("<th class='ui-state-default ui-th-subgrid ui-th-column ui-th-"+j.p.direction+"'></th>");a(t).html(j.p.subGridModel[0].name[r]);a(t).width(j.p.subGridModel[0].width[r]);a(n).append(t)}a(s).append(n);if(o){q=j.p.xmlReader.subgrid;a(q.root+" "+q.row,o).each(function(){n=a("<tr class='ui-widget-content ui-subtblcell'></tr>");if(q.repeatitems===true){a(q.cell,this).each(function(w){e(n,a(this).text()||"&#160;",w)})}else{var v=j.p.subGridModel[0].mapping||j.p.subGridModel[0].name;if(v){for(r=0;r<v.length;r++){e(n,a(v[r],this).text()||"&#160;",r)}}}a(s).append(n)})}var p=a("table:first",j.grid.bDiv).attr("id")+"_";a("#"+p+u).append(s);j.grid.hDiv.loading=false;a("#load_"+j.p.id).hide();return false};var f=function(u,r){var w,y,s,v,n,q,p=a("<table cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>"),o=a("<tr></tr>");for(s=0;s<j.p.subGridModel[0].name.length;s++){w=a("<th class='ui-state-default ui-th-subgrid ui-th-column ui-th-"+j.p.direction+"'></th>");a(w).html(j.p.subGridModel[0].name[s]);a(w).width(j.p.subGridModel[0].width[s]);a(o).append(w)}a(p).append(o);if(u){n=j.p.jsonReader.subgrid;y=u[n.root];if(typeof y!=="undefined"){for(s=0;s<y.length;s++){v=y[s];o=a("<tr class='ui-widget-content ui-subtblcell'></tr>");if(n.repeatitems===true){if(n.cell){v=v[n.cell]}for(q=0;q<v.length;q++){e(o,v[q]||"&#160;",q)}}else{var t=j.p.subGridModel[0].mapping||j.p.subGridModel[0].name;if(t.length){for(q=0;q<t.length;q++){e(o,v[t[q]]||"&#160;",q)}}}a(p).append(o)}}}var x=a("table:first",j.grid.bDiv).attr("id")+"_";a("#"+x+r).append(p);j.grid.hDiv.loading=false;a("#load_"+j.p.id).hide();return false};var k=function(q){var n,r,p,o;n=a(q).attr("id");r={nd_:(new Date().getTime())};r[j.p.prmNames.subgridid]=n;if(!j.p.subGridModel[0]){return false}if(j.p.subGridModel[0].params){for(o=0;o<j.p.subGridModel[0].params.length;o++){for(p=0;p<j.p.colModel.length;p++){if(j.p.colModel[p].name==j.p.subGridModel[0].params[o]){r[j.p.colModel[p].name]=a("td:eq("+p+")",q).text().replace(/\&#160\;/ig,"")}}}}if(!j.grid.hDiv.loading){j.grid.hDiv.loading=true;a("#load_"+j.p.id).show();if(!j.p.subgridtype){j.p.subgridtype=j.p.datatype}if(a.isFunction(j.p.subgridtype)){j.p.subgridtype.call(j,r)}else{j.p.subgridtype=j.p.subgridtype.toLowerCase()}switch(j.p.subgridtype){case"xml":case"json":a.ajax(a.extend({type:j.p.mtype,url:j.p.subGridUrl,dataType:j.p.subgridtype,data:a.isFunction(j.p.serializeSubGridData)?j.p.serializeSubGridData.call(j,r):r,complete:function(s){if(j.p.subgridtype=="xml"){d(s.responseXML,n)}else{f(a.jgrid.parse(s.responseText),n)}s=null}},a.jgrid.ajaxOptions,j.p.ajaxSubgridOptions||{}));break}}return false};var l,m,h,i=0,g,c;a.each(j.p.colModel,function(o,n){if(this.hidden===true||this.name=="rn"||this.name=="cb"){i++}});a(j.rows).each(function(n){var o=this;if(a(o).hasClass("jqgrow")){a(this.cells[b]).bind("click",function(p){c=o.nextSibling;if(a(this).hasClass("sgcollapsed")){m=j.p.id;l=o.id;if(j.p.subGridOptions.reloadOnExpand===true||(j.p.subGridOptions.reloadOnExpand===false&&!a(c).hasClass("ui-subgrid"))){h=b>=1?"<td colspan='"+b+"'>&#160;</td>":"";g=true;if(a.isFunction(j.p.subGridBeforeExpand)){g=j.p.subGridBeforeExpand.call(j,m+"_"+l,l)}if(g===false){return false}a(o).after("<tr role='row' class='ui-subgrid'>"+h+"<td class='ui-widget-content subgrid-cell'><span class='ui-icon "+j.p.subGridOptions.openicon+"'></span></td><td colspan='"+parseInt(j.p.colNames.length-1-i,10)+"' class='ui-widget-content subgrid-data'><div id="+m+"_"+l+" class='tablediv'></div></td></tr>");if(a.isFunction(j.p.subGridRowExpanded)){j.p.subGridRowExpanded.call(j,m+"_"+l,l)}else{k(o)}}else{a(c).show()}a(this).html("<a href='javascript:void(0);'><span class='ui-icon "+j.p.subGridOptions.minusicon+"'></span></a>").removeClass("sgcollapsed").addClass("sgexpanded");if(j.p.subGridOptions.selectOnExpand){a(j).jqGrid("setSelection",l)}}else{if(a(this).hasClass("sgexpanded")){g=true;if(a.isFunction(j.p.subGridRowColapsed)){l=o.id;g=j.p.subGridRowColapsed.call(j,m+"_"+l,l)}if(g===false){return false}if(j.p.subGridOptions.reloadOnExpand===true){a(c).remove(".ui-subgrid")}else{if(a(c).hasClass("ui-subgrid")){a(c).hide()}}a(this).html("<a href='javascript:void(0);'><span class='ui-icon "+j.p.subGridOptions.plusicon+"'></span></a>").removeClass("sgexpanded").addClass("sgcollapsed")}}return false});if(j.p.subGridOptions.expandOnLoad===true){setTimeout(function(){a(o.cells[b]).trigger("click")},n*j.p.subGridOptions.delayOnLoad)}}});j.subGridXml=function(o,n){d(o,n)};j.subGridJson=function(o,n){f(o,n)}})},expandSubGridRow:function(b){return this.each(function(){var e=this;if(!e.grid&&!b){return}if(e.p.subGrid===true){var c=a(this).jqGrid("getInd",b,true);if(c){var d=a("td.sgcollapsed",c)[0];if(d){a(d).trigger("click")}}}})},collapseSubGridRow:function(b){return this.each(function(){var e=this;if(!e.grid&&!b){return}if(e.p.subGrid===true){var c=a(this).jqGrid("getInd",b,true);if(c){var d=a("td.sgexpanded",c)[0];if(d){a(d).trigger("click")}}}})},toggleSubGridRow:function(b){return this.each(function(){var e=this;if(!e.grid&&!b){return}if(e.p.subGrid===true){var c=a(this).jqGrid("getInd",b,true);if(c){var d=a("td.sgcollapsed",c)[0];if(d){a(d).trigger("click")}else{d=a("td.sgexpanded",c)[0];if(d){a(d).trigger("click")}}}}})}})})(jQuery);