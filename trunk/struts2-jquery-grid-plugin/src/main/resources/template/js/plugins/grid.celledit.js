/*
**
 * jqGrid extension for cellediting Grid Data
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/ 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
**/ 
(function(a){a.jgrid.extend({editCell:function(d,c,b){return this.each(function(){var l=this,e,h,k;if(!l.grid||l.p.cellEdit!==true){return}c=parseInt(c,10);l.p.selrow=l.rows[d].id;if(!l.p.knv){a(l).jqGrid("GridNav")}if(l.p.savedRow.length>0){if(b===true){if(d==l.p.iRow&&c==l.p.iCol){return}}a(l).jqGrid("saveCell",l.p.savedRow[0].id,l.p.savedRow[0].ic)}else{window.setTimeout(function(){a("#"+l.p.knv).attr("tabindex","-1").focus()},0)}e=l.p.colModel[c].name;if(e=="subgrid"||e=="cb"||e=="rn"){return}k=a("td:eq("+c+")",l.rows[d]);if(l.p.colModel[c].editable===true&&b===true&&!k.hasClass("not-editable-cell")){if(parseInt(l.p.iCol,10)>=0&&parseInt(l.p.iRow,10)>=0){a("td:eq("+l.p.iCol+")",l.rows[l.p.iRow]).removeClass("edit-cell ui-state-highlight");a(l.rows[l.p.iRow]).removeClass("selected-row ui-state-hover")}a(k).addClass("edit-cell ui-state-highlight");a(l.rows[d]).addClass("selected-row ui-state-hover");try{h=a.unformat(k,{rowId:l.rows[d].id,colModel:l.p.colModel[c]},c)}catch(f){h=a(k).html()}if(l.p.autoencode){h=a.jgrid.htmlDecode(h)}if(!l.p.colModel[c].edittype){l.p.colModel[c].edittype="text"}l.p.savedRow.push({id:d,ic:c,name:e,v:h});if(a.isFunction(l.p.formatCell)){var i=l.p.formatCell(l.rows[d].id,e,h,d,c);if(i!==undefined){h=i}}var g=a.extend({},l.p.colModel[c].editoptions||{},{id:d+"_"+e,name:e});var j=createEl(l.p.colModel[c].edittype,g,h,true,a.extend({},a.jgrid.ajaxOptions,l.p.ajaxSelectOptions||{}));if(a.isFunction(l.p.beforeEditCell)){l.p.beforeEditCell(l.rows[d].id,e,h,d,c)}a(k).html("").append(j).attr("tabindex","0");window.setTimeout(function(){a(j).focus()},0);a("input, select, textarea",k).bind("keydown",function(m){if(m.keyCode===27){if(a("input.hasDatepicker",k).length>0){if(a(".ui-datepicker").is(":hidden")){a(l).jqGrid("restoreCell",d,c)}else{a("input.hasDatepicker",k).datepicker("hide")}}else{a(l).jqGrid("restoreCell",d,c)}}if(m.keyCode===13){a(l).jqGrid("saveCell",d,c)}if(m.keyCode==9){if(!l.grid.hDiv.loading){if(m.shiftKey){a(l).jqGrid("prevCell",d,c)}else{a(l).jqGrid("nextCell",d,c)}}else{return false}}m.stopPropagation()});if(a.isFunction(l.p.afterEditCell)){l.p.afterEditCell(l.rows[d].id,e,h,d,c)}}else{if(parseInt(l.p.iCol,10)>=0&&parseInt(l.p.iRow,10)>=0){a("td:eq("+l.p.iCol+")",l.rows[l.p.iRow]).removeClass("edit-cell ui-state-highlight");a(l.rows[l.p.iRow]).removeClass("selected-row ui-state-hover")}k.addClass("edit-cell ui-state-highlight");a(l.rows[d]).addClass("selected-row ui-state-hover");if(a.isFunction(l.p.onSelectCell)){h=k.html().replace(/\&#160\;/ig,"");l.p.onSelectCell(l.rows[d].id,e,h,d,c)}}l.p.iCol=c;l.p.iRow=d})},saveCell:function(c,b){return this.each(function(){var u=this,h;if(!u.grid||u.p.cellEdit!==true){return}if(u.p.savedRow.length>=1){h=0}else{h=null}if(h!==null){var p=a("td:eq("+b+")",u.rows[c]),n,d,j=u.p.colModel[b],f=j.name,i=a.jgrid.jqID(f);switch(j.edittype){case"select":if(!j.editoptions.multiple){n=a("#"+c+"_"+i+">option:selected",u.rows[c]).val();d=a("#"+c+"_"+i+">option:selected",u.rows[c]).text()}else{var t=a("#"+c+"_"+i,u.rows[c]),s=[];n=a(t).val();if(n){n.join(",")}else{n=""}a("option:selected",t).each(function(e,v){s[e]=a(v).text()});d=s.join(",")}if(j.formatter){d=n}break;case"checkbox":var q=["Yes","No"];if(j.editoptions){q=j.editoptions.value.split(":")}n=a("#"+c+"_"+i,u.rows[c]).attr("checked")?q[0]:q[1];d=n;break;case"password":case"text":case"textarea":case"button":n=a("#"+c+"_"+i,u.rows[c]).val();d=n;break;case"custom":try{if(j.editoptions&&a.isFunction(j.editoptions.custom_value)){n=j.editoptions.custom_value(a(".customelement",p),"get");if(n===undefined){throw"e2"}else{d=n}}else{throw"e1"}}catch(w){if(w=="e1"){info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.nodefined,jQuery.jgrid.edit.bClose)}if(w=="e2"){info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.novalue,jQuery.jgrid.edit.bClose)}else{info_dialog(jQuery.jgrid.errors.errcap,w.message,jQuery.jgrid.edit.bClose)}}break}if(d!=u.p.savedRow[h].v){if(a.isFunction(u.p.beforeSaveCell)){var r=u.p.beforeSaveCell(u.rows[c].id,f,n,c,b);if(r){n=r}}var g=checkValues(n,b,u);if(g[0]===true){var l={};if(a.isFunction(u.p.beforeSubmitCell)){l=u.p.beforeSubmitCell(u.rows[c].id,f,n,c,b);if(!l){l={}}}if(a("input.hasDatepicker",p).length>0){a("input.hasDatepicker",p).datepicker("hide")}if(u.p.cellsubmit=="remote"){if(u.p.cellurl){var x={};if(u.p.autoencode){n=a.jgrid.htmlEncode(n)}x[f]=n;var o,m,k;k=u.p.prmNames;o=k.id;m=k.oper;x[o]=u.rows[c].id;x[m]=k.editoper;x=a.extend(l,x);a("#lui_"+u.p.id).show();u.grid.hDiv.loading=true;a.ajax(a.extend({url:u.p.cellurl,data:a.isFunction(u.p.serializeCellData)?u.p.serializeCellData(x):x,type:"POST",complete:function(e,y){a("#lui_"+u.p.id).hide();u.grid.hDiv.loading=false;if(y=="success"){if(a.isFunction(u.p.afterSubmitCell)){var v=u.p.afterSubmitCell(e,x.id,f,n,c,b);if(v[0]===true){a(p).empty();a(u).jqGrid("setCell",u.rows[c].id,b,d,false,false,true);a(p).addClass("dirty-cell");a(u.rows[c]).addClass("edited");if(a.isFunction(u.p.afterSaveCell)){u.p.afterSaveCell(u.rows[c].id,f,n,c,b)}u.p.savedRow.splice(0,1)}else{info_dialog(a.jgrid.errors.errcap,v[1],a.jgrid.edit.bClose);a(u).jqGrid("restoreCell",c,b)}}else{a(p).empty();a(u).jqGrid("setCell",u.rows[c].id,b,d,false,false,true);a(p).addClass("dirty-cell");a(u.rows[c]).addClass("edited");if(a.isFunction(u.p.afterSaveCell)){u.p.afterSaveCell(u.rows[c].id,f,n,c,b)}u.p.savedRow.splice(0,1)}}},error:function(e,v){a("#lui_"+u.p.id).hide();u.grid.hDiv.loading=false;if(a.isFunction(u.p.errorCell)){u.p.errorCell(e,v);a(u).jqGrid("restoreCell",c,b)}else{info_dialog(a.jgrid.errors.errcap,e.status+" : "+e.statusText+"<br/>"+v,a.jgrid.edit.bClose);a(u).jqGrid("restoreCell",c,b)}}},a.jgrid.ajaxOptions,u.p.ajaxCellOptions||{}))}else{try{info_dialog(a.jgrid.errors.errcap,a.jgrid.errors.nourl,a.jgrid.edit.bClose);a(u).jqGrid("restoreCell",c,b)}catch(w){}}}if(u.p.cellsubmit=="clientArray"){a(p).empty();a(u).jqGrid("setCell",u.rows[c].id,b,d,false,false,true);a(p).addClass("dirty-cell");a(u.rows[c]).addClass("edited");if(a.isFunction(u.p.afterSaveCell)){u.p.afterSaveCell(u.rows[c].id,f,n,c,b)}u.p.savedRow.splice(0,1)}}else{try{window.setTimeout(function(){info_dialog(a.jgrid.errors.errcap,n+" "+g[1],a.jgrid.edit.bClose)},100);a(u).jqGrid("restoreCell",c,b)}catch(w){}}}else{a(u).jqGrid("restoreCell",c,b)}}if(a.browser.opera){a("#"+u.p.knv).attr("tabindex","-1").focus()}else{window.setTimeout(function(){a("#"+u.p.knv).attr("tabindex","-1").focus()},0)}})},restoreCell:function(c,b){return this.each(function(){var h=this,d;if(!h.grid||h.p.cellEdit!==true){return}if(h.p.savedRow.length>=1){d=0}else{d=null}if(d!==null){var g=a("td:eq("+b+")",h.rows[c]);if(a.isFunction(a.fn.datepicker)){try{a("input.hasDatepicker",g).datepicker("hide")}catch(f){}}a(g).empty().attr("tabindex","-1");a(h).jqGrid("setCell",h.rows[c].id,b,h.p.savedRow[d].v,false,false,true);if(a.isFunction(h.p.afterRestoreCell)){h.p.afterRestoreCell(h.rows[c].id,h.p.savedRow[d].v,c,b)}h.p.savedRow.splice(0,1)}window.setTimeout(function(){a("#"+h.p.knv).attr("tabindex","-1").focus()},0)})},nextCell:function(c,b){return this.each(function(){var f=this,e=false;if(!f.grid||f.p.cellEdit!==true){return}for(var d=b+1;d<f.p.colModel.length;d++){if(f.p.colModel[d].editable===true){e=d;break}}if(e!==false){a(f).jqGrid("editCell",c,e,true)}else{if(f.p.savedRow.length>0){a(f).jqGrid("saveCell",c,b)}}})},prevCell:function(c,b){return this.each(function(){var f=this,e=false;if(!f.grid||f.p.cellEdit!==true){return}for(var d=b-1;d>=0;d--){if(f.p.colModel[d].editable===true){e=d;break}}if(e!==false){a(f).jqGrid("editCell",c,e,true)}else{if(f.p.savedRow.length>0){a(f).jqGrid("saveCell",c,b)}}})},GridNav:function(){return this.each(function(){var g=this;if(!g.grid||g.p.cellEdit!==true){return}g.p.knv=g.p.id+"_kn";var f=a("<span style='width:0px;height:0px;background-color:black;' tabindex='0'><span tabindex='-1' style='width:0px;height:0px;background-color:grey' id='"+g.p.knv+"'></span></span>"),d,c;a(f).insertBefore(g.grid.cDiv);a("#"+g.p.knv).focus().keydown(function(h){c=h.keyCode;if(g.p.direction=="rtl"){if(c==37){c=39}else{if(c==39){c=37}}}switch(c){case 38:if(g.p.iRow-1>=0){e(g.p.iRow-1,g.p.iCol,"vu");a(g).jqGrid("editCell",g.p.iRow-1,g.p.iCol,false)}break;case 40:if(g.p.iRow+1<=g.rows.length-1){e(g.p.iRow+1,g.p.iCol,"vd");a(g).jqGrid("editCell",g.p.iRow+1,g.p.iCol,false)}break;case 37:if(g.p.iCol-1>=0){d=b(g.p.iCol-1,"lft");e(g.p.iRow,d,"h");a(g).jqGrid("editCell",g.p.iRow,d,false)}break;case 39:if(g.p.iCol+1<=g.p.colModel.length-1){d=b(g.p.iCol+1,"rgt");e(g.p.iRow,d,"h");a(g).jqGrid("editCell",g.p.iRow,d,false)}break;case 13:if(parseInt(g.p.iCol,10)>=0&&parseInt(g.p.iRow,10)>=0){a(g).jqGrid("editCell",g.p.iRow,g.p.iCol,true)}break}return false});function e(p,n,o){if(o.substr(0,1)=="v"){var h=a(g.grid.bDiv)[0].clientHeight,q=a(g.grid.bDiv)[0].scrollTop,r=g.rows[p].offsetTop+g.rows[p].clientHeight,l=g.rows[p].offsetTop;if(o=="vd"){if(r>=h){a(g.grid.bDiv)[0].scrollTop=a(g.grid.bDiv)[0].scrollTop+g.rows[p].clientHeight}}if(o=="vu"){if(l<q){a(g.grid.bDiv)[0].scrollTop=a(g.grid.bDiv)[0].scrollTop-g.rows[p].clientHeight}}}if(o=="h"){var k=a(g.grid.bDiv)[0].clientWidth,j=a(g.grid.bDiv)[0].scrollLeft,i=g.rows[p].cells[n].offsetLeft+g.rows[p].cells[n].clientWidth,m=g.rows[p].cells[n].offsetLeft;if(i>=k+parseInt(j,10)){a(g.grid.bDiv)[0].scrollLeft=a(g.grid.bDiv)[0].scrollLeft+g.rows[p].cells[n].clientWidth}else{if(m<j){a(g.grid.bDiv)[0].scrollLeft=a(g.grid.bDiv)[0].scrollLeft-g.rows[p].cells[n].clientWidth}}}}function b(l,h){var k,j;if(h=="lft"){k=l+1;for(j=l;j>=0;j--){if(g.p.colModel[j].hidden!==true){k=j;break}}}if(h=="rgt"){k=l-1;for(j=l;j<g.p.colModel.length;j++){if(g.p.colModel[j].hidden!==true){k=j;break}}}return k}})},getChangedCells:function(c){var b=[];if(!c){c="all"}this.each(function(){var e=this,d;if(!e.grid||e.p.cellEdit!==true){return}a(e.rows).each(function(f){var g={};if(a(this).hasClass("edited")){a("td",this).each(function(h){d=e.p.colModel[h].name;if(d!=="cb"&&d!=="subgrid"){if(c=="dirty"){if(a(this).hasClass("dirty-cell")){try{g[d]=a.unformat(this,{rowId:e.rows[f].id,colModel:e.p.colModel[h]},h)}catch(j){g[d]=a.jgrid.htmlDecode(a(this).html())}}}else{try{g[d]=a.unformat(this,{rowId:e.rows[f].id,colModel:e.p.colModel[h]},h)}catch(j){g[d]=a.jgrid.htmlDecode(a(this).html())}}}});g.id=this.id;b.push(g)}})});return b}})})(jQuery);