/**
 * jqGrid extension for manipulating Grid Data
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
**/
(function(a){a.jgrid.inlineEdit=a.jgrid.inlineEdit||{};a.jgrid.extend({editRow:function(c,l,k,f,b,g,e,h,i){var d={},j=a.makeArray(arguments).slice(1);if(a.type(j[0])==="object"){d=j[0]}else{if(l!==undefined){d.keys=l}if(a.isFunction(k)){d.oneditfunc=k}if(a.isFunction(f)){d.successfunc=f}if(b!==undefined){d.url=b}if(g!==undefined){d.extraparam=g}if(a.isFunction(e)){d.aftersavefunc=e}if(a.isFunction(h)){d.errorfunc=h}if(a.isFunction(i)){d.afterrestorefunc=i}}d=a.extend(true,{keys:false,oneditfunc:null,successfunc:null,url:null,extraparam:{},aftersavefunc:null,errorfunc:null,afterrestorefunc:null,restoreAfterError:true,mtype:"POST"},a.jgrid.inlineEdit,d);return this.each(function(){var p=this,u,q,n,o=0,t=null,s={},m,r;if(!p.grid){return}m=a(p).jqGrid("getInd",c,true);if(m===false){return}n=a(m).attr("editable")||"0";if(n=="0"&&!a(m).hasClass("not-editable-row")){r=p.p.colModel;a('td[role="gridcell"]',m).each(function(y){u=r[y].name;var x=p.p.treeGrid===true&&u==p.p.ExpandColumn;if(x){q=a("span:first",this).html()}else{try{q=a.unformat.call(p,this,{rowId:c,colModel:r[y]},y)}catch(v){q=(r[y].edittype&&r[y].edittype=="textarea")?a(this).text():a(this).html()}}if(u!="cb"&&u!="subgrid"&&u!="rn"){if(p.p.autoencode){q=a.jgrid.htmlDecode(q)}s[u]=q;if(r[y].editable===true){if(t===null){t=y}if(x){a("span:first",this).html("")}else{a(this).html("")}var w=a.extend({},r[y].editoptions||{},{id:c+"_"+u,name:u});if(!r[y].edittype){r[y].edittype="text"}if(q=="&nbsp;"||q=="&#160;"||(q.length==1&&q.charCodeAt(0)==160)){q=""}var z=a.jgrid.createEl.call(p,r[y].edittype,w,q,true,a.extend({},a.jgrid.ajaxOptions,p.p.ajaxSelectOptions||{}));a(z).addClass("editable");if(x){a("span:first",this).append(z)}else{a(this).append(z)}a.jgrid.bindEv(z,w,p);if(r[y].edittype=="select"&&r[y].editoptions!==undefined&&r[y].editoptions.multiple===true&&r[y].editoptions.dataUrl===undefined&&a.jgrid.msie){a(z).width(a(z).width())}o++}}});if(o>0){s.id=c;p.p.savedRow.push(s);a(m).attr("editable","1");a("td:eq("+t+") input",m).focus();if(d.keys===true){a(m).bind("keydown",function(w){if(w.keyCode===27){a(p).jqGrid("restoreRow",c,d.afterrestorefunc);if(p.p._inlinenav){try{a(p).jqGrid("showAddEditButtons")}catch(y){}}return false}if(w.keyCode===13){var v=w.target;if(v.tagName=="TEXTAREA"){return true}if(a(p).jqGrid("saveRow",c,d)){if(p.p._inlinenav){try{a(p).jqGrid("showAddEditButtons")}catch(x){}}}return false}})}a(p).triggerHandler("jqGridInlineEditRow",[c,d]);if(a.isFunction(d.oneditfunc)){d.oneditfunc.call(p,c)}}}})},saveRow:function(n,j,g,h,t,r,b){var d=a.makeArray(arguments).slice(1),C={};if(a.type(d[0])==="object"){C=d[0]}else{if(a.isFunction(j)){C.successfunc=j}if(g!==undefined){C.url=g}if(h!==undefined){C.extraparam=h}if(a.isFunction(t)){C.aftersavefunc=t}if(a.isFunction(r)){C.errorfunc=r}if(a.isFunction(b)){C.afterrestorefunc=b}}C=a.extend(true,{successfunc:null,url:null,extraparam:{},aftersavefunc:null,errorfunc:null,afterrestorefunc:null,restoreAfterError:true,mtype:"POST"},a.jgrid.inlineEdit,C);var q=false;var G=this[0],c,I={},B={},A={},D,m,f,w;if(!G.grid){return q}w=a(G).jqGrid("getInd",n,true);if(w===false){return q}D=a(w).attr("editable");C.url=C.url||G.p.editurl;if(D==="1"){var u;a('td[role="gridcell"]',w).each(function(o){u=G.p.colModel[o];c=u.name;if(c!="cb"&&c!="subgrid"&&u.editable===true&&c!="rn"&&!a(this).hasClass("not-editable-cell")){switch(u.edittype){case"checkbox":var k=["Yes","No"];if(u.editoptions){k=u.editoptions.value.split(":")}I[c]=a("input",this).is(":checked")?k[0]:k[1];break;case"text":case"password":case"textarea":case"button":I[c]=a("input, textarea",this).val();break;case"select":if(!u.editoptions.multiple){I[c]=a("select option:selected",this).val();B[c]=a("select option:selected",this).text()}else{var J=a("select",this),L=[];I[c]=a(J).val();if(I[c]){I[c]=I[c].join(",")}else{I[c]=""}a("select option:selected",this).each(function(e,M){L[e]=a(M).text()});B[c]=L.join(",")}if(u.formatter&&u.formatter=="select"){B={}}break;case"custom":try{if(u.editoptions&&a.isFunction(u.editoptions.custom_value)){I[c]=u.editoptions.custom_value.call(G,a(".customelement",this),"get");if(I[c]===undefined){throw"e2"}}else{throw"e1"}}catch(K){if(K=="e1"){a.jgrid.info_dialog(a.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.nodefined,a.jgrid.edit.bClose)}if(K=="e2"){a.jgrid.info_dialog(a.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.novalue,a.jgrid.edit.bClose)}else{a.jgrid.info_dialog(a.jgrid.errors.errcap,K.message,a.jgrid.edit.bClose)}}break}f=a.jgrid.checkValues(I[c],o,G);if(f[0]===false){f[1]=I[c]+" "+f[1];return false}if(G.p.autoencode){I[c]=a.jgrid.htmlEncode(I[c])}if(C.url!=="clientArray"&&u.editoptions&&u.editoptions.NullIfEmpty===true){if(I[c]===""){A[c]="null"}}}});if(f[0]===false){try{var s=a.jgrid.findPos(a("#"+a.jgrid.jqID(n),G.grid.bDiv)[0]);a.jgrid.info_dialog(a.jgrid.errors.errcap,f[1],a.jgrid.edit.bClose,{left:s[0],top:s[1]})}catch(H){alert(f[1])}return q}var y,v=G.p.prmNames,p=n;if(G.p.keyIndex===false){y=v.id}else{y=G.p.colModel[G.p.keyIndex+(G.p.rownumbers===true?1:0)+(G.p.multiselect===true?1:0)+(G.p.subGrid===true?1:0)].name}if(I){I[v.oper]=v.editoper;if(I[y]===undefined){I[y]=n}else{if(w.id!==G.p.idPrefix+I[y]){var x=a.jgrid.stripPref(G.p.idPrefix,n);if(G.p._index[x]!==undefined){G.p._index[I[y]]=G.p._index[x];delete G.p._index[x]}n=G.p.idPrefix+I[y];a(w).attr("id",n);if(G.p.selrow===p){G.p.selrow=n}if(a.isArray(G.p.selarrrow)){var F=a.inArray(p,G.p.selarrrow);if(F>=0){G.p.selarrrow[F]=n}}if(G.p.multiselect){var l="jqg_"+G.p.id+"_"+n;a("input.cbox",w).attr("id",l).attr("name",l)}}}if(G.p.inlineData===undefined){G.p.inlineData={}}I=a.extend({},I,G.p.inlineData,C.extraparam)}if(C.url=="clientArray"){I=a.extend({},I,B);if(G.p.autoencode){a.each(I,function(i,e){I[i]=a.jgrid.htmlDecode(e)})}var E,z=a(G).jqGrid("setRowData",n,I);a(w).attr("editable","0");for(E=0;E<G.p.savedRow.length;E++){if(G.p.savedRow[E].id==p){m=E;break}}if(m>=0){G.p.savedRow.splice(m,1)}a(G).triggerHandler("jqGridInlineAfterSaveRow",[n,z,I,C]);if(a.isFunction(C.aftersavefunc)){C.aftersavefunc.call(G,n,z,C)}q=true;a(w).unbind("keydown")}else{a("#lui_"+a.jgrid.jqID(G.p.id)).show();A=a.extend({},I,A);A[y]=a.jgrid.stripPref(G.p.idPrefix,A[y]);a.ajax(a.extend({url:C.url,data:a.isFunction(G.p.serializeRowData)?G.p.serializeRowData.call(G,A):A,type:C.mtype,async:false,complete:function(o,J){a("#lui_"+a.jgrid.jqID(G.p.id)).hide();if(J==="success"){var i=true,K,e;K=a(G).triggerHandler("jqGridInlineSuccessSaveRow",[o,n,C]);if(!a.isArray(K)){K=[true,I]}if(K[0]&&a.isFunction(C.successfunc)){K=C.successfunc.call(G,o)}if(a.isArray(K)){i=K[0];I=K[1]||I}else{i=K}if(i===true){if(G.p.autoencode){a.each(I,function(L,k){I[L]=a.jgrid.htmlDecode(k)})}I=a.extend({},I,B);a(G).jqGrid("setRowData",n,I);a(w).attr("editable","0");for(e=0;e<G.p.savedRow.length;e++){if(G.p.savedRow[e].id==n){m=e;break}}if(m>=0){G.p.savedRow.splice(m,1)}a(G).triggerHandler("jqGridInlineAfterSaveRow",[n,o,I,C]);if(a.isFunction(C.aftersavefunc)){C.aftersavefunc.call(G,n,o)}q=true;a(w).unbind("keydown")}else{a(G).triggerHandler("jqGridInlineErrorSaveRow",[n,o,J,null,C]);if(a.isFunction(C.errorfunc)){C.errorfunc.call(G,n,o,J,null)}if(C.restoreAfterError===true){a(G).jqGrid("restoreRow",n,C.afterrestorefunc)}}}},error:function(k,o,J){a("#lui_"+a.jgrid.jqID(G.p.id)).hide();a(G).triggerHandler("jqGridInlineErrorSaveRow",[n,k,o,J,C]);if(a.isFunction(C.errorfunc)){C.errorfunc.call(G,n,k,o,J)}else{var i=k.responseText||k.statusText;try{a.jgrid.info_dialog(a.jgrid.errors.errcap,'<div class="ui-state-error">'+i+"</div>",a.jgrid.edit.bClose,{buttonalign:"right"})}catch(K){alert(i)}}if(C.restoreAfterError===true){a(G).jqGrid("restoreRow",n,C.afterrestorefunc)}}},a.jgrid.ajaxOptions,G.p.ajaxRowOptions||{}))}}return q},restoreRow:function(d,b){var c=a.makeArray(arguments).slice(1),e={};if(a.type(c[0])==="object"){e=c[0]}else{if(a.isFunction(b)){e.afterrestorefunc=b}}e=a.extend(true,a.jgrid.inlineEdit,e);return this.each(function(){var l=this,f,h,j={},g;if(!l.grid){return}h=a(l).jqGrid("getInd",d,true);if(h===false){return}for(g=0;g<l.p.savedRow.length;g++){if(l.p.savedRow[g].id==d){f=g;break}}if(f>=0){if(a.isFunction(a.fn.datepicker)){try{a("input.hasDatepicker","#"+a.jgrid.jqID(h.id)).datepicker("hide")}catch(i){}}a.each(l.p.colModel,function(){if(this.editable===true&&l.p.savedRow[f].hasOwnProperty(this.name)){j[this.name]=l.p.savedRow[f][this.name]}});a(l).jqGrid("setRowData",d,j);a(h).attr("editable","0").unbind("keydown");l.p.savedRow.splice(f,1);if(a("#"+a.jgrid.jqID(d),"#"+a.jgrid.jqID(l.p.id)).hasClass("jqgrid-new-row")){setTimeout(function(){a(l).jqGrid("delRowData",d)},0)}}a(l).triggerHandler("jqGridInlineAfterRestoreRow",[d]);if(a.isFunction(e.afterrestorefunc)){e.afterrestorefunc.call(l,d)}})},addRow:function(b){b=a.extend(true,{rowID:null,initdata:{},position:"first",useDefValues:true,useFormatter:false,addRowParams:{extraparam:{}}},b||{});return this.each(function(){if(!this.grid){return}var e=this;b.rowID=a.isFunction(b.rowID)?b.rowID.call(e,b):((b.rowID!=null)?b.rowID:a.jgrid.randId());if(b.useDefValues===true){a(e.p.colModel).each(function(){if(this.editoptions&&this.editoptions.defaultValue){var g=this.editoptions.defaultValue,f=a.isFunction(g)?g.call(e):g;b.initdata[this.name]=f}})}a(e).jqGrid("addRowData",b.rowID,b.initdata,b.position);b.rowID=e.p.idPrefix+b.rowID;a("#"+a.jgrid.jqID(b.rowID),"#"+a.jgrid.jqID(e.p.id)).addClass("jqgrid-new-row");if(b.useFormatter){a("#"+a.jgrid.jqID(b.rowID)+" .ui-inline-edit","#"+a.jgrid.jqID(e.p.id)).click()}else{var c=e.p.prmNames,d=c.oper;b.addRowParams.extraparam[d]=c.addoper;a(e).jqGrid("editRow",b.rowID,b.addRowParams);a(e).jqGrid("setSelection",b.rowID)}})},inlineNav:function(b,c){c=a.extend({edit:true,editicon:"ui-icon-pencil",add:true,addicon:"ui-icon-plus",save:true,saveicon:"ui-icon-disk",cancel:true,cancelicon:"ui-icon-cancel",addParams:{},editParams:{},restoreAfterSelect:true},a.jgrid.nav,c||{});return this.each(function(){if(!this.grid){return}var k=this,e,h=a.jgrid.jqID(k.p.id);k.p._inlinenav=true;if(c.addParams.useFormatter===true){var d=k.p.colModel,g;for(g=0;g<d.length;g++){if(d[g].formatter&&d[g].formatter==="actions"){if(d[g].formatoptions){var j={keys:false,onEdit:null,onSuccess:null,afterSave:null,onError:null,afterRestore:null,extraparam:{},url:null},f=a.extend(j,d[g].formatoptions);c.addParams.addRowParams={keys:f.keys,oneditfunc:f.onEdit,successfunc:f.onSuccess,url:f.url,extraparam:f.extraparam,aftersavefunc:f.afterSavef,errorfunc:f.onError,afterrestorefunc:f.afterRestore}}break}}}if(c.add){a(k).jqGrid("navButtonAdd",b,{caption:c.addtext,title:c.addtitle,buttonicon:c.addicon,id:k.p.id+"_iladd",onClickButton:function(){a(k).jqGrid("addRow",c.addParams);if(!c.addParams.useFormatter){a("#"+h+"_ilsave").removeClass("ui-state-disabled");a("#"+h+"_ilcancel").removeClass("ui-state-disabled");a("#"+h+"_iladd").addClass("ui-state-disabled");a("#"+h+"_iledit").addClass("ui-state-disabled")}}})}if(c.edit){a(k).jqGrid("navButtonAdd",b,{caption:c.edittext,title:c.edittitle,buttonicon:c.editicon,id:k.p.id+"_iledit",onClickButton:function(){var i=a(k).jqGrid("getGridParam","selrow");if(i){a(k).jqGrid("editRow",i,c.editParams);a("#"+h+"_ilsave").removeClass("ui-state-disabled");a("#"+h+"_ilcancel").removeClass("ui-state-disabled");a("#"+h+"_iladd").addClass("ui-state-disabled");a("#"+h+"_iledit").addClass("ui-state-disabled")}else{a.jgrid.viewModal("#alertmod",{gbox:"#gbox_"+h,jqm:true});a("#jqg_alrt").focus()}}})}if(c.save){a(k).jqGrid("navButtonAdd",b,{caption:c.savetext||"",title:c.savetitle||"Save row",buttonicon:c.saveicon,id:k.p.id+"_ilsave",onClickButton:function(){var l=k.p.savedRow[0].id;if(l){var i=k.p.prmNames,m=i.oper;if(!c.editParams.extraparam){c.editParams.extraparam={}}if(a("#"+a.jgrid.jqID(l),"#"+h).hasClass("jqgrid-new-row")){c.editParams.extraparam[m]=i.addoper}else{c.editParams.extraparam[m]=i.editoper}if(a(k).jqGrid("saveRow",l,c.editParams)){a(k).jqGrid("showAddEditButtons")}}else{a.jgrid.viewModal("#alertmod",{gbox:"#gbox_"+h,jqm:true});a("#jqg_alrt").focus()}}});a("#"+h+"_ilsave").addClass("ui-state-disabled")}if(c.cancel){a(k).jqGrid("navButtonAdd",b,{caption:c.canceltext||"",title:c.canceltitle||"Cancel row editing",buttonicon:c.cancelicon,id:k.p.id+"_ilcancel",onClickButton:function(){var i=k.p.savedRow[0].id;if(i){a(k).jqGrid("restoreRow",i,c.editParams);a(k).jqGrid("showAddEditButtons")}else{a.jgrid.viewModal("#alertmod",{gbox:"#gbox_"+h,jqm:true});a("#jqg_alrt").focus()}}});a("#"+h+"_ilcancel").addClass("ui-state-disabled")}if(c.restoreAfterSelect===true){if(a.isFunction(k.p.beforeSelectRow)){e=k.p.beforeSelectRow}else{e=false}k.p.beforeSelectRow=function(m,l){var i=true;if(k.p.savedRow.length>0&&k.p._inlinenav===true&&(m!==k.p.selrow&&k.p.selrow!==null)){if(k.p.selrow==c.addParams.rowID){a(k).jqGrid("delRowData",k.p.selrow)}else{a(k).jqGrid("restoreRow",k.p.selrow,c.editParams)}a(k).jqGrid("showAddEditButtons")}if(e){i=e.call(k,m,l)}return i}}})},showAddEditButtons:function(){return this.each(function(){if(!this.grid){return}var b=a.jgrid.jqID(this.p.id);a("#"+b+"_ilsave").addClass("ui-state-disabled");a("#"+b+"_ilcancel").addClass("ui-state-disabled");a("#"+b+"_iladd").removeClass("ui-state-disabled");a("#"+b+"_iledit").removeClass("ui-state-disabled")})}})})(jQuery);