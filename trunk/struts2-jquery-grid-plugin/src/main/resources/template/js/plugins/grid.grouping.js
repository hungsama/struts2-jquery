// Grouping module
(function(a){a.jgrid.extend({groupingSetup:function(){return this.each(function(){var g=this,c=g.p.groupingView;if(c!==null&&((typeof c==="object")||a.isFunction(c))){if(!c.groupField.length){g.p.grouping=false}else{for(var e=0;e<c.groupField.length;e++){if(!c.groupOrder[e]){c.groupOrder[e]="asc"}if(!c.groupText[e]){c.groupText[e]="{0}"}if(typeof(c.groupColumnShow[e])!="boolean"){c.groupColumnShow[e]=true}if(typeof(c.groupSummary[e])!="boolean"){c.groupSummary[e]=false}if(c.groupColumnShow[e]===true){a(g).jqGrid("showCol",c.groupField[e])}else{a(g).jqGrid("hideCol",c.groupField[e])}c.sortitems[e]=[];c.sortnames[e]=[];c.summaryval[e]=[];if(c.groupSummary[e]){c.summary[e]=[];var b=g.p.colModel;for(var d=0,f=b.length;d<f;d++){if(b[d].summaryType){c.summary[e].push({nm:b[d].name,st:b[d].summaryType,v:""})}}}}g.p.scroll=false;g.p.rownumbers=false;g.p.subGrid=false;g.p.treeGrid=false;g.p.gridview=true}}else{g.p.grouping=false}})},groupingPrepare:function(d,c,e,b){this.each(function(){var h=c[0]?c[0].split(" ").join(""):"";var f=this.p.groupingView,g=this;if(e.hasOwnProperty(h)){e[h].push(d)}else{e[h]=[];e[h].push(d);f.sortitems[0].push(h);f.sortnames[0].push(a.trim(c[0]));f.summaryval[0][h]=a.extend(true,{},f.summary[0])}if(f.groupSummary[0]){a.each(f.summaryval[0][h],function(j,k){if(a.isFunction(this.st)){this.v=this.st.call(g,this.v,this.nm,b)}else{this.v=a(g).jqGrid("groupingCalculations."+this.st,this.v,this.nm,b)}})}});return e},groupingToggle:function(b){this.each(function(){var i=this,c=i.p.groupingView,g=b.lastIndexOf("_"),e=b.substring(0,g+1),d=parseInt(b.substring(g+1),10)+1,f=c.minusicon,h=c.plusicon;if(a("#"+b+" span").hasClass(f)){if(c.showSummaryOnHide&&c.groupSummary[0]){a("#"+b).nextUntil(".jqfoot").hide()}else{a("#"+b).nextUntil("#"+e+String(d)).hide()}a("#"+b+" span").removeClass(f).addClass(h)}else{a("#"+b).nextUntil("#"+e+String(d)).show();a("#"+b+" span").removeClass(h).addClass(f)}});return false},groupingRender:function(b,c){return this.each(function(){var i=this,d=i.p.groupingView,h="",g="",f,e="";if(!d.groupDataSorted){d.sortitems[0].sort();d.sortnames[0].sort();if(d.groupOrder[0].toLowerCase()=="desc"){d.sortitems[0].reverse()}}if(d.groupCollapse){e=d.plusicon}else{e=d.minusicon}e+=" tree-wrap-"+i.p.direction;a.each(d.sortitems[0],function(p,m){f=i.p.id+"ghead_"+p;g="<span style='cursor:pointer;' class='ui-icon "+e+"' onclick=\"jQuery('#"+i.p.id+"').jqGrid('groupingToggle','"+f+"');return false;\"></span>";h+='<tr id="'+f+'" role="row" class= "ui-widget-content jqgroup ui-row-'+i.p.direction+'"><td colspan="'+c+'">'+g+a.jgrid.format(d.groupText[0],d.sortnames[0][p],b[m].length)+"</td></tr>";for(var l=0;l<b[m].length;l++){h+=b[m][l].join("")}if(d.groupSummary[0]){var r="";if(d.groupCollapse&&!d.showSummaryOnHide){r=' style="display:none;"'}h+="<tr"+r+' role="row" class="ui-widget-content jqfoot ui-row-'+i.p.direction+'">';var q=d.summaryval[0][m],t=i.p.colModel,s,u=b[m].length;for(var o=0;o<c;o++){var j="<td "+i.formatCol(o,1,"")+">&#160;</td>",v="{0}";a.each(q,function(){if(this.nm==t[o].name){if(t[o].summaryTpl){v=t[o].summaryTpl}if(this.st=="avg"){if(this.v&&u>0){this.v=(this.v/u)}}try{s=i.formatter("",this.v,o,this)}catch(k){s=this.v}j="<td "+i.formatCol(o,1,"")+">"+a.jgrid.format(v,s)+"</td>";return false}});h+=j}h+="</tr>"}});a("#"+i.p.id+" tbody:first").append(h);h=null})},groupingGroupBy:function(c,b,d){return this.each(function(){var g=this;if(typeof(c)=="string"){c=[c]}var e=g.p.groupingView;g.p.grouping=true;for(var f=0;f<e.groupField.length;f++){if(!e.groupColumnShow[f]){a(g).jqGrid("showCol",e.groupField[f])}}g.p.groupingView=a.extend(g.p.groupingView,b||{});e.groupField=c;a(g).trigger("reloadGrid")})},groupingRemove:function(b){return this.each(function(){var c=this;if(typeof(b)=="undefined"){b=true}c.p.grouping=false;if(b===true){a("tr.jqgroup, tr.jqfoot","#"+c.p.id+" tbody:first").remove()}else{a(c).trigger("reloadGrid")}})},groupingCalculations:{sum:function(b,d,c){return parseFloat(b||0)+parseFloat((c[d]||0))},min:function(b,d,c){if(b===""){return parseFloat(c[d]||0)}return Math.min(parseFloat(b),parseFloat(c[d]||0))},max:function(b,d,c){if(b===""){return parseFloat(c[d]||0)}return Math.max(parseFloat(b),parseFloat(c[d]||0))},count:function(b,d,c){if(b===""){b=0}if(c.hasOwnProperty(d)){return b+1}else{return 0}},avg:function(b,d,c){return parseFloat(b||0)+parseFloat((c[d]||0))}}})})(jQuery);