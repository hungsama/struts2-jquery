/**
 * jqGrid extension for SubGrid Data
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
**/
(function(a){a.jgrid.extend({setSubGrid:function(){return this.each(function(){var d=this,b;d.p.colNames.unshift("");d.p.colModel.unshift({name:"subgrid",width:a.browser.safari?d.p.subGridWidth+d.p.cellLayout:d.p.subGridWidth,sortable:false,resizable:false,hidedlg:true,search:false,fixed:true});b=d.p.subGridModel;if(b[0]){b[0].align=a.extend([],b[0].align||[]);for(var c=0;c<b[0].name.length;c++){b[0].align[c]=b[0].align[c]||"left"}}})},addSubGridCell:function(f,d){var c="",e,b;this.each(function(){c=this.formatCol(f,d);e=this.p.gridview;b=this.p.id});if(e===false){return'<td role="grid" aria-describedby="'+b+'_subgrid" class="ui-sgcollapsed sgcollapsed" '+c+"><a href='javascript:void(0);'><span class='ui-icon ui-icon-plus'></span></a></td>"}else{return'<td role="grid" aria-describedby="'+b+'_subgrid" '+c+"></td>"}},addSubGrid:function(b,c){return this.each(function(){var k=this;if(!k.grid){return}var e=function(q,p,s){var r=a("<td align='"+k.p.subGridModel[0].align[s]+"'></td>").html(p);a(q).append(r)};var d=function(q,w){var v,t,s,u=a("<table cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>"),p=a("<tr></tr>");for(t=0;t<k.p.subGridModel[0].name.length;t++){v=a("<th class='ui-state-default ui-th-subgrid ui-th-column ui-th-"+k.p.direction+"'></th>");a(v).html(k.p.subGridModel[0].name[t]);a(v).width(k.p.subGridModel[0].width[t]);a(p).append(v)}a(u).append(p);if(q){s=k.p.xmlReader.subgrid;a(s.root+" "+s.row,q).each(function(){p=a("<tr class='ui-widget-content ui-subtblcell'></tr>");if(s.repeatitems===true){a(s.cell,this).each(function(y){e(p,a(this).text()||"&#160;",y)})}else{var x=k.p.subGridModel[0].mapping||k.p.subGridModel[0].name;if(x){for(t=0;t<x.length;t++){e(p,a(x[t],this).text()||"&#160;",t)}}}a(u).append(p)})}var r=a("table:first",k.grid.bDiv).attr("id")+"_";a("#"+r+w).append(u);k.grid.hDiv.loading=false;a("#load_"+k.p.id).hide();return false};var f=function(w,t){var y,A,u,x,p,s,r=a("<table cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>"),q=a("<tr></tr>");for(u=0;u<k.p.subGridModel[0].name.length;u++){y=a("<th class='ui-state-default ui-th-subgrid ui-th-column ui-th-"+k.p.direction+"'></th>");a(y).html(k.p.subGridModel[0].name[u]);a(y).width(k.p.subGridModel[0].width[u]);a(q).append(y)}a(r).append(q);if(w){p=k.p.jsonReader.subgrid;A=w[p.root];if(typeof A!=="undefined"){for(u=0;u<A.length;u++){x=A[u];q=a("<tr class='ui-widget-content ui-subtblcell'></tr>");if(p.repeatitems===true){if(p.cell){x=x[p.cell]}for(s=0;s<x.length;s++){e(q,x[s]||"&#160;",s)}}else{var v=k.p.subGridModel[0].mapping||k.p.subGridModel[0].name;if(v.length){for(s=0;s<v.length;s++){e(q,x[v[s]]||"&#160;",s)}}}a(r).append(q)}}}var z=a("table:first",k.grid.bDiv).attr("id")+"_";a("#"+z+t).append(r);k.grid.hDiv.loading=false;a("#load_"+k.p.id).hide();return false};var m=function(s){var p,t,r,q;p=a(s).attr("id");t={nd_:(new Date().getTime())};t[k.p.prmNames.subgridid]=p;if(!k.p.subGridModel[0]){return false}if(k.p.subGridModel[0].params){for(q=0;q<k.p.subGridModel[0].params.length;q++){for(r=0;r<k.p.colModel.length;r++){if(k.p.colModel[r].name==k.p.subGridModel[0].params[q]){t[k.p.colModel[r].name]=a("td:eq("+r+")",s).text().replace(/\&#160\;/ig,"")}}}}if(!k.grid.hDiv.loading){k.grid.hDiv.loading=true;a("#load_"+k.p.id).show();if(!k.p.subgridtype){k.p.subgridtype=k.p.datatype}if(a.isFunction(k.p.subgridtype)){k.p.subgridtype.call(k,t)}else{k.p.subgridtype=k.p.subgridtype.toLowerCase()}switch(k.p.subgridtype){case"xml":case"json":a.ajax(a.extend({type:k.p.mtype,url:k.p.subGridUrl,dataType:k.p.subgridtype,data:a.isFunction(k.p.serializeSubGridData)?k.p.serializeSubGridData.call(k,t):t,complete:function(u){if(k.p.subgridtype=="xml"){d(u.responseXML,p)}else{f(a.jgrid.parse(u.responseText),p)}u=null}},a.jgrid.ajaxOptions,k.p.ajaxSubgridOptions||{}));break}}return false};var l,n,o,i,j,h,g;a("td:eq("+c+")",b).click(function(p){if(a(this).hasClass("sgcollapsed")){o=k.p.id;l=a(this).parent();i=c>=1?"<td colspan='"+c+"'>&#160;</td>":"";n=a(l).attr("id");g=true;if(a.isFunction(k.p.subGridBeforeExpand)){g=k.p.subGridBeforeExpand.call(k,o+"_"+n,n)}if(g===false){return false}j=0;a.each(k.p.colModel,function(r,q){if(this.hidden===true||this.name=="rn"||this.name=="cb"){j++}});h="<tr role='row' class='ui-subgrid'>"+i+"<td class='ui-widget-content subgrid-cell'><span class='ui-icon ui-icon-carat-1-sw'/></td><td colspan='"+parseInt(k.p.colNames.length-1-j,10)+"' class='ui-widget-content subgrid-data'><div id="+o+"_"+n+" class='tablediv'>";a(this).parent().after(h+"</div></td></tr>");if(a.isFunction(k.p.subGridRowExpanded)){k.p.subGridRowExpanded.call(k,o+"_"+n,n)}else{m(l)}a(this).html("<a href='javascript:void(0);'><span class='ui-icon ui-icon-minus'></span></a>").removeClass("sgcollapsed").addClass("sgexpanded")}else{if(a(this).hasClass("sgexpanded")){g=true;if(a.isFunction(k.p.subGridRowColapsed)){l=a(this).parent();n=a(l).attr("id");g=k.p.subGridRowColapsed.call(k,o+"_"+n,n)}if(g===false){return false}a(this).parent().next().remove(".ui-subgrid");a(this).html("<a href='javascript:void(0);'><span class='ui-icon ui-icon-plus'></span></a>").removeClass("sgexpanded").addClass("sgcollapsed")}}return false});k.subGridXml=function(q,p){d(q,p)};k.subGridJson=function(q,p){f(q,p)}})},expandSubGridRow:function(b){return this.each(function(){var e=this;if(!e.grid&&!b){return}if(e.p.subGrid===true){var c=a(this).jqGrid("getInd",b,true);if(c){var d=a("td.sgcollapsed",c)[0];if(d){a(d).trigger("click")}}}})},collapseSubGridRow:function(b){return this.each(function(){var e=this;if(!e.grid&&!b){return}if(e.p.subGrid===true){var c=a(this).jqGrid("getInd",b,true);if(c){var d=a("td.sgexpanded",c)[0];if(d){a(d).trigger("click")}}}})},toggleSubGridRow:function(b){return this.each(function(){var e=this;if(!e.grid&&!b){return}if(e.p.subGrid===true){var c=a(this).jqGrid("getInd",b,true);if(c){var d=a("td.sgcollapsed",c)[0];if(d){a(d).trigger("click")}else{d=a("td.sgexpanded",c)[0];if(d){a(d).trigger("click")}}}}})}})})(jQuery);