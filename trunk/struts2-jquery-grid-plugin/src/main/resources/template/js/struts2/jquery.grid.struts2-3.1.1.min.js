/*!
 * jquery.grid.struts2.js
 *
 * Integration of jqGrid with struts 2
 *
 * Requires use of jquery.struts2.js
 *
 * Copyright (c) 2011 Johannes Geppert http://www.jgeppert.com
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 */
(function(h){h.struts2_jquery_grid={debugPrefix:"[struts2_jquery_grid] ",lastselectedrow:"",navigatorButtons:function(d,a,g){var c=this;h.each(a,function(a,f){if(f.title)if(f.title==="seperator")d.jqGrid("navSeparatorAdd",g);else if(f.topic||f.onclick){var e={};if(f.id)e.title=f.id;if(f.title)e.title=f.title;if(f.position)e.position=f.position;e.caption=f.caption?f.caption:"";e.buttonicon=f.icon?f.icon:"ui-icon-gear";if(f.topic)e.onClickButton=function(){var a={};a.grid=d;c.publishTopic(d,f.topic, a)};else if(f.onclick)e.onClickButton=f.onclick;d.jqGrid("navButtonAdd",g,e)}})},parseGridParams:function(d,a,g){var c=this;if(a.onselectrowtopics||a.editurl&&a.editinline===!0)g.onSelectRow=function(f,e){var b={};b.id=f;b.status=e;b.grid=d;c.publishTopic(d,a.onalw,b);h.struts2_jquery.publishTopic(d,a.onselectrowtopics,b);if(a.editurl&&a.editinline===!0){h.struts2_jquery_grid.lastselectedrow!==""&&d.jqGrid("restoreRow",h.struts2_jquery_grid.lastselectedrow);h.struts2_jquery_grid.lastselectedrow=f; var g=null,j=null,i=null,k=null;a.oneibefore&&(g=function(){c.publishTopic(d,a.oneibefore,b)});a.oneisuccess&&(j=function(b){var e={};e.response=b;c.publishTopic(d,a.oneisuccess,e);return b.status>=400?!1:!0});a.oneierror&&(i=function(b,e){var f={};f.rowid=b;f.response=e;c.publishTopic(d,a.oneierror,f)});a.oneisave&&(k=function(b,e){var f={};f.rowid=b;f.response=e;c.publishTopic(d,a.oneisave,f)});d.jqGrid("editRow",f,!0,g,j,null,null,k,i,null)}};if(a.oncesuccess)g.afterSaveCell=function(f,e,b,g,h){var i= {};i.rowid=f;i.cellname=e;i.value=b;i.iRow=g;i.iCol=h;c.publishTopic(d,a.oncesuccess,i)};if(a.onceerror)g.errorCell=function(f,e){var b={};b.response=f;b.status=e;c.publishTopic(d,a.onceerror,b)};if(a.onselectalltopics)g.onSelectAll=function(f,e){var b={};b.ids=f;b.status=e;b.grid=d;c.publishTopic(d,a.onalw,b);c.publishTopic(d,a.onselectalltopics,b)};if(a.onbef)g.loadBeforeSend=function(f){var e={};e.xhr=f;c.publishTopic(d,a.onalw,e);c.publishTopic(d,a.onbef,e)};if(a.onpagingtopics)g.onPaging=function(f){var e= {};e.pgButton=f;c.publishTopic(d,a.onalw,e);c.publishTopic(d,a.onpagingtopics,e)};if(a.onsortcoltopics)g.onSortCol=function(f,e,b){var g={};g.index=f;g.iCol=e;g.sortorder=b;c.publishTopic(d,a.onalw,g);c.publishTopic(d,a.onsortcoltopics,g)};if(a.oncellselecttopics)g.onCellSelect=function(f,e,b,g){var h={};h.rowid=f;h.iCol=e;h.cellcontent=b;h.e=g;c.publishTopic(d,a.onalw,h);c.publishTopic(d,a.oncellselecttopics,h)};g.gridComplete=function(){if(!d.data("_s2jg_init")){d.data("_s2jg_init",!0);if(a.draggable&& a.droppable){c.log("drag and drop for grid : "+a.id);c.loadAtOnce||c.require(["js/base/jquery.ui.widget"+c.minSuffix+".js","js/base/jquery.ui.mouse"+c.minSuffix+".js","js/base/jquery.ui.draggable"+c.minSuffix+".js","js/base/jquery.ui.droppable"+c.minSuffix+".js"]);var f=a.draggableoptions,e=a.droppableoptions,b={},g=window[f],g=g?{}:eval("( "+f+" )");g.drap=c.pubTops(d,a.onalw,a.draggableondragtopics);f=(f=window[e])?{}:eval("( "+e+" )");f.activate=c.pubTops(d,a.onalw,a.droppableonactivatetopics); f.deactivate=c.pubTops(d,a.onalw,a.droppableondeactivatetopics);f.start=c.pubTops(d,a.onalw,a.droppableonstarttopics);f.stop=c.pubTops(d,a.onalw,a.droppableonstoptopics);b.drag_opts=g;b.drop_opts=f;b.connectWith=a.connectWith;b.onstart=c.pubTops(d,a.onalw,a.draggableonstarttopics);b.onstop=c.pubTops(d,a.onalw,a.draggableonstoptopics);b.ondrop=c.pubTops(d,a.onalw,a.droppableondroptopics);d.jqGrid("gridDnD",b)}if(a.sortableRows)c.log("sortable rows for : "+a.id),e=a.sortableoptions,b=(b=window[e])? {}:eval("( "+e+" )"),b.beforeStop=c.pubTops(d,a.onalw,a.sortableonbeforestoptopics),b.stop=c.pubTops(d,a.onalw,a.sortableonstoptopics),b.start=c.pubTops(d,a.onalw,a.sortableonstarttopics),b.sort=c.pubTops(d,a.onalw,a.sortableonsorttopics),b.activate=c.pubTops(d,a.onalw,a.sortableonactivatetopics),b.deactivate=c.pubTops(d,a.onalw,a.sortableondeactivatetopics),b.over=c.pubTops(d,a.onalw,a.sortableonovertopics),b.out=c.pubTops(d,a.onalw,a.sortableonouttopics),b.remove=c.pubTops(d,a.onalw,a.sortableonremovetopics), b.receive=c.pubTops(d,a.onalw,a.sortableonreceivetopics),b.change=c.pubTops(d,a.onalw,a.sortableonchangetopics),b.update=c.pubTops(d,a.onalw,a.sortableonupdatetopics),d.jqGrid("sortableRows",b);if(a.navigator)e={},e.add=a.navigatoradd,e.del=a.navigatordel,e.edit=a.navigatoredit,e.refresh=a.navigatorrefresh,e.search=a.navigatorsearch,e.view=a.navigatorview,d.jqGrid("navGrid",c.escId(a.pager),e,a.navigatoreditoptions,a.navigatoraddoptions,a.navigatordeleteoptions,a.navigatorsearchoptions,a.navigatorviewoptions), a.navigatorextrabuttons&&c.navigatorButtons(d,a.navigatorextrabuttons,c.escId(a.pager));if(a.filter){e={};if(a.filteroptions)e=a.filteroptions;d.jqGrid("filterToolbar",e)}if(a.resizable)c.loadAtOnce||c.require(["js/base/jquery.ui.widget"+c.minSuffix+".js","js/base/jquery.ui.mouse"+c.minSuffix+".js","js/base/jquery.ui.resizable"+c.minSuffix+".js"]),e=a.resizableoptions,b=(b=window[e])?{}:eval("( "+e+" )"),b.start=c.pubTops(d,a.onalw,a.resizableonstarttopics),b.stop=c.pubTops(d,a.onalw,a.resizableonstoptopics), b.resize=c.pubTops(d,a.onalw,a.resizableonresizetopics),d.jqGrid("gridResize",b)}a.ongridcompletetopics&&(c.publishTopic(d,a.onalwaystopics,{}),c.publishTopic(d,a.ongridcompletetopics,{}))};if(a.onfocustopics)g.beforeSelectRow=function(f,e){var b={};b.rowid=f;b.e=e;c.publishTopic(d,a.onalw,b);c.publishTopic(d,a.onfocustopics,b)};a.reloadtopics&&h.each(a.reloadtopics.split(","),function(c,e){d.subscribe(e,"_s2j_reloadgrid",a)});if(!g.loadtext&&c.defaults.loadingText!==null)g.loadtext=c.defaults.loadingText; g.loadComplete=c.pubCom(d,a.onalw,a.oncom,null,null,a);g.loadError=c.pubErr(d,a.onalw,a.onerr,a.errortext);a.grouping&&c.require("js/plugins/grid.grouping.js");a.editurl&&(c.require("js/plugins/grid.filter.js"),c.require("js/plugins/grid.formedit.js"),a.editinline&&c.require("js/plugins/grid.inlinedit.js"));a.cellurl&&c.require("js/plugins/grid.celledit.js");a.navigator&&c.require("js/plugins/grid.formedit.js");a.navigatorsearch&&c.require("js/plugins/grid.filter.js");a.subgrid?(c.require("js/plugins/grid.subgrid.js"), g.subGrid=!0,g.gridview=!1,g.subGridRowExpanded=function(f,e){var b={proceed:!0};if(a.onsgrowexpanded)b.row_id=e,b.subgrid_id=f,c.publishTopic(d,a.onalw,b),c.publishTopic(d,a.onsgrowexpanded,b);if(b.proceed){var b=a.subgridoptions,g=f+"_table",j=h(c.escId(f)),i="<table id='"+g+"' class='scroll'></table>";if(b.pager&&b.pager!==""||b.navigator)i=i+"<div id='"+f+"_pager'></div>",b.pager=f+"_pager",b.navigatoraddoptions=h.extend(!0,b.navigatoraddoptions||{},{editData:{rowid:e}}),b.navigatoreditoptions= h.extend(!0,b.navigatoreditoptions||{},{editData:{rowid:e}}),b.navigatordeleteoptions=h.extend(!0,b.navigatordeleteoptions||{},{delData:{rowid:e}});j.html(i);if(b.url){j=b.url.indexOf("?");if(j>0)b.url=b.url.substring(0,j);b.url=b.url+"?id="+e}j=h(c.escId(g));b=c.parseGridParams(j,b,b);j.jqGrid(b)}}):g.gridview=!0;if(a.url&&a.formids){var k="";a.formids&&(c.loadAtOnce||c.require("js/plugins/jquery.form"+c.minSuffix+".js"),h.each(a.formids.split(","),function(a,d){var b=h(c.escId(d)).formSerialize(); k=k!==""?k+"&"+b:b}));g.url=a.url.lastIndexOf("?")>0?a.url+"&amp;"+k:a.url+"?"+k}return g},grid:function(d,a){this.log("grid for : "+a.id);this.require("i18n/grid.locale-"+this.gridLocal+".js",function(){h.jgrid.no_legacy_api=!0;h.jgrid.useJSON=!0});this.require("js/plugins/jquery.jqGrid.js");this.requireCss("themes/ui.jqgrid.css");if(a.sortable||a.sortableRows)this.loadAtOnce||this.require(["js/base/jquery.ui.widget"+this.minSuffix+".js","js/base/jquery.ui.mouse"+this.minSuffix+".js","js/base/jquery.ui.sortable"+ this.minSuffix+".js"]);var g={};h.extend(g,a);d.data("_s2jg_init",!1);g=this.parseGridParams(d,a,g);d.jqGrid(g)}};h.extend(h.struts2_jquery_grid,h.struts2_jquery);h.subscribeHandler("_s2j_reloadgrid",function(d){var a=h.struts2_jquery_grid,g={};h.extend(g,d.data);if(g.id){if(g.url&&g.formids){var c="";g.formids&&(a.loadAtOnce||a.require("js/plugins/jquery.form"+a.minSuffix+".js"),h.each(g.formids.split(","),function(d,f){var e=h(a.escId(f)).formSerialize();c=c!==""?c+"&"+e:e}));g.url=g.url.lastIndexOf("?")> 0?g.url+"&amp;"+c:g.url+"?"+c}d=h(a.escId(g.id));d.jqGrid("setGridParam",{url:g.url});a.log("reload grid "+g.id);d.trigger("reloadGrid")}})})(jQuery);