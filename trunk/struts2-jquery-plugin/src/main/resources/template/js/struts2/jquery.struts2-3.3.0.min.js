/*!
 * jquery.struts2.js
 *
 * Integration of jquery and jquery ui with struts 2
 * for ajax, widget and interactions support in struts 2
 *
 * Requires use of jQuery.
 * Tested with jQuery 1.7 and jQuery UI 1.8
 *
 * Copyright (c) 2008 Eric Chijioke (obinna a-t g mail dot c o m)
 * Copyright (c) 2012 Johannes Geppert http://www.jgeppert.com
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 */
(function(a){a.struts2_jquery={debug:false,debugPrefix:"[struts2_jquery] ",ajaxhistory:false,loadAtOnce:false,local:"en",gridLocal:"en",timeLocal:"en",minSuffix:".min",historyelements:{},forms:{},scriptCache:{},styleCache:{},defaults:{indicator:"",loadingText:null,errorText:null},handler:{load:"_s2j_container_load",form:"_s2j_form_submit",effect:"_s2j_effects"},currentXhr:{},log:function(c){var b=this;if(b.debug){var d=b.debugPrefix+c;if(window.console&&window.console.log){window.console.log(d)}else{if(window.opera&&window.opera.postError){window.opera.postError(d)}}}},escId:function(b){return"#"+b.replace(/(:|\.)/g,"\\$1")},addParam:function(b,c){if(b.indexOf("?")>0){return b=b+"&"+c}else{return b+"?"+c}},changeParam:function(c,g,f){var d=c.split("?");var e=d[1].split("&");var b=[];for(i=0;i<e.length;i++){b=e[i].split("=");if(b[0]==g){e[i]=b[0]+"="+f}}return d[0]+"?"+e.join("&")},require:function(d,e,g){var c=this;var b,f;b=e||function(){};f=g||null;if(f===null&&!a.scriptPath){f=""}else{if(f===null&&a.scriptPath){f=a.scriptPath}}if(typeof d==="string"){d=d.split(",")}a.each(d,function(j,h){h=c.addParam(h,"s2j="+c.version);if(!c.scriptCache[h]){c.log("load require script "+(f+h));a.ajax({type:"GET",scriptCharset:"UTF-8",url:f+h,success:b,dataType:"script",cache:true,async:false});c.scriptCache[h]=true}})},requireCss:function(b,f){var d=this;if(!d.styleCache[b]){var e,c;e=f||null;if(e===null&&!a.scriptPath){e=""}else{if(e===null&&a.scriptPath){e=a.scriptPath}}d.log("load require css "+(e+b));c=document.createElement("link");c.setAttribute("rel","stylesheet");c.setAttribute("type","text/css");c.setAttribute("href",(e+b));document.getElementsByTagName("head")[0].appendChild(c);d.styleCache[b]=true}},hideIndicator:function(c){var b=this;if(c){a(b.escId(c)).hide()}if(b.defaults.indicator!==""){a(b.escId(b.defaults.indicator)).hide()}},showIndicator:function(c){var b=this;if(c){a(b.escId(c)).show()}if(b.defaults.indicator!==""){a(b.escId(b.defaults.indicator)).show()}},abortReq:function(d){var b=this;var c=b.currentXhr[d];if(c&&c!==null){if(c.readyState<4){c.abort()}}},validateForm:function(c,f){var b=this;var d=true;var e={};if(!b.loadAtOnce){b.require("js/plugins/jquery.form"+b.minSuffix+".js")}e.type="POST";e.data={"struts.enableJSONValidation":true,"struts.validateOnly":true};if(f.href&&f.href!=="#"){e.url=f.href}else{e.url=c[0].action}if(f.hrefparameter){e.url=e.url+"?"+f.hrefparameter}e.cache=false;e.async=false;e.complete=function(j,g){var k=a(c[0]);var l=j.responseText;if(a.isFunction(f.validateFunction)){if(l&&l.length>10){d=false;var m;if(l.substring(0,2)==="/*"){m=a.parseJSON(l.substring(2,l.length-2))}else{m=a.parseJSON(l)}f.validateFunction(k,m)}}else{if(StrutsUtils!==undefined){StrutsUtils.clearValidationErrors(c[0]);var h;if(l.substring(0,2)==="/*"){h=StrutsUtils.getValidationErrors(l)}else{h=StrutsUtils.getValidationErrors(a.parseJSON(l))}if(h.fieldErrors||h.errors){StrutsUtils.showValidationErrors(c[0],h);d=false}}}b.log("form validation : "+d)};c.ajaxSubmit(e);return d},addForms:function(c,d){var b=this;if(c){if(!b.loadAtOnce){b.require("js/plugins/jquery.form"+b.minSuffix+".js")}a.each(c.split(","),function(e,h){var g=a(b.escId(h)).formSerialize();d=b.addParam(d,g)})}return d},pubTops:function(d,b,e){var c=this;if(e){return function(f,h){var g={};g.event=f;g.ui=h;c.publishTopic(d,e,g);c.publishTopic(d,b,g)}}else{return null}},subscribeTopics:function(d,f,c,e){var b=this;if(f&&d){a.each(f.split(","),function(h,g){b.log("subscribe topic : "+g);if(d.isSubscribed(g)){d.destroyTopic(g)}d.subscribe(g,c,e)})}},publishTopic:function(c,e,d){var b=this;if(e){a.each(e.split(","),function(f,g){b.log("publish topic : "+g);c.publish(g,c,d)})}},pubSuc:function(k,b,f,j,e,g){var d=this;var h=a(k);return function(r,l,p){var q={};q.data=r;q.status=l;q.request=p;if(e==="html"&&!a.isArray(r)&&!a.isPlainObject(r)){h.html(r)}else{if(e==="value"){h.val(a.trim(r))}else{if(e==="select"||e==="radio"||e==="checkbox"){if(e==="select"){h[0].length=0}else{h.children().remove()}if(typeof(r)==="object"||a.isArray(r)){var o=-1;if(e==="select"){if(g.headerkey&&g.headervalue){var m=a('<option value="'+g.headerkey+'">'+g.headervalue+"</option>");if(g.value===g.headervalue){m.prop("selected",true)}m.appendTo(h)}if(g.emptyoption){a("<option></option>").appendTo(h)}}var c=0;if(r[g.list]!==null){var n=false;if(!a.isArray(r[g.list])){n=true}a.each(r[g.list],function(u,x){var w={};if(e==="radio"||e==="checkbox"){w.name=g.name}if(n){w.text=x;w.value=u}else{if(g.listkey!==undefined&&g.listvalue!==undefined){w.text=x[g.listvalue];w.value=x[g.listkey]}else{w.text=r[g.list][c];w.value=r[g.list][c]}}if(g.value!==undefined&&g.value==w.value){w.selected=true}if(e==="select"){var s=a('<option value="'+w.value+'">'+w.text+"</option>");if(w.selected){s.prop("selected",true)}s.appendTo(h)}else{var v;var t=++o;if(e==="radio"){v=a('<input name="'+w.name+'" type="radio" id="'+w.name+(t)+'" value="'+w.value+'"></input>')}else{if(e==="checkbox"){v=a('<input name="'+w.name+'" type="checkbox" id="'+w.name+(t)+'" value="'+w.value+'"></input>')}}if(w.selected){v.prop("checked",true)}h.append(v);h.append(a('<label id="'+w.name+(t)+'label" for="'+w.name+(t)+'">'+w.text+"</label>"))}c++})}}}}}if(f){d.publishTopic(h,f,q);d.publishTopic(h,b,q)}}},pubCom:function(k,b,f,d,j,g){var e=this;var h=a(k);return function(m,c){var o={};o.request=m;o.status=c;e.hideIndicator(j);e.publishTopic(h,f,o);e.publishTopic(h,b,o);var l=d;if(!l){l=g.id}if(l){var n="_sj_div_effect_";a.each(l.split(","),function(p,r){var q=a(e.escId(r));q.publish(n+r+g.id,g)})}if(a.struts2_jquery_ui&&g.resizable){a.struts2_jquery_ui.resizable(h,g)}}},pubErr:function(j,b,h,g,e){var d=this;var f=a(j);if(h||g){return function(l,c,k){var m={};m.request=l;m.status=c;m.error=k;if(e==="html"||e==="value"){if(g&&g!=="false"){f.html(g)}else{if(d.defaults.errorText!==null){f.html(d.defaults.errorText)}}}d.publishTopic(f,h,m);d.publishTopic(f,b,m)}}else{return null}},preBind:null,postBind:null,bind:function(e,f){var c=this;if(e){var d=a(e);e=d[0];var b=e.tagName.toLowerCase();f.tagname=b;if(typeof(c.preBind)!=="function"||c.preBind(d)){if(!f.jqueryaction){f.jqueryaction=b}c.log("bind "+f.jqueryaction+" on "+f.id);c[f.jqueryaction](d,f);if(c.postBind&&(typeof(c.postBind)==="function")){return c.postBind(e)}}}},jqueryaction:function(d,b){var c=this;if(d&&b){c[d]=b}},history:function(c,d,e){var b=this;var f={};f.target=e;f.topic=d;c.bind("click",f,function(g){b.historyelements[g.data.target]=g.data.topic;b.lasttopic=d;a.bbq.pushState(b.historyelements);return false});a(window).bind("hashchange",f,function(h){var g=h.getState(h.data.target)||"";a.each(h.fragment.split("&"),function(k,l){var j=l.split("=");if(b.historyelements[j[0]]!==j[1]&&j[1]!==b.lasttopic){b.lasttopic=g;a.publish(j[1],h.data.options)}})})},action:function(c,d,k,e){var g=this;var f="_sj_action_"+d.id;d.actionTopic=f;var b=d.href;if(b===null||b===""){b="#";d.href=b}var h="_sj_div_effect_";var j={};j.effect=d.effect;j.effectoptions=d.effectoptions;j.effectmode=d.effectmode;j.oneffect=d.oneffect;j.effectduration=d.effectduration;if(d.datatype&&!d.targets){if(d.datatype==="json"){d.targets="false"}}if(d.targets){a.each(d.targets.split(","),function(l,m){j.targets=m;var n=a(g.escId(m));if(n.length===0){n=c}g.subscribeTopics(n,f,k,d);g.subscribeTopics(n,h+m+d.id,g.handler.effect,j);if(g.ajaxhistory){g.history(c,f,m)}})}else{j.targets=d.id;g.subscribeTopics(a(g.escId(d.id)),h+d.id+d.id,g.handler.effect,j);if(d.onbef||d.oncom||d.onsuc||d.onerr){g.subscribeTopics(c,f,k,d)}}if(e==="a"){c.click(function(){c.publish(f);if(d.preventAction){return false}})}},container:function(c,e){var k=this;k.log("container : "+e.id);k.action(c,e,k.handler.load,"div");var g="_s2j_div_load_"+e.id;var f="_s2j_div_effect_"+e.id;var h=a.struts2_jquery_ui;if((e.formids&&!e.type)||(e.href&&e.href!=="#")){if(e.href!=="#"){k.subscribeTopics(c,e.reloadtopics,k.handler.load,e);k.subscribeTopics(c,e.listentopics,k.handler.load,e);k.subscribeTopics(c,g,k.handler.load,e);if(e.bindon){var b=a("#"+e.bindon);if(e.events){a.each(e.events.split(","),function(m,n){b.publishOnEvent(n,g,e)})}else{b.publishOnEvent("click",g,e)}}else{if(!e.deferredloading){c.publish(g,e)}}}else{if(e.formids){if(!k.loadAtOnce){k.require("js/plugins/jquery.form"+k.minSuffix+".js")}e.targets=e.id;k.formsubmit(c,e,g);if(!e.deferredloading){c.publish(g,e)}}}}else{if(e.id&&e.effect){var l={};l.targets=e.id;l.effect=e.effect;l.effectoptions=e.effectoptions;l.effectduration=e.effectduration;k.subscribeTopics(c,f+e.id+e.id,k.handler.effect,l)}if(e.events||e.bindon){var d=c;var j="click";if(e.bindon){d=a(k.escId(e.bindon))}if(e.events){j=e.events}a.each(j.split(","),function(m,n){if(e.onbef){a.each(e.onbef.split(","),function(o,p){d.publishOnEvent(n,p)})}d.publishOnEvent(n,f+e.id+e.id,e);if(e.oncom){a.each(e.oncom.split(","),function(o,p){d.publishOnEvent(n,p)})}})}else{if(e.onbef){a.each(e.onbef.split(","),function(m,n){c.publish(n,e)})}c.publish(f+e.id+e.id,e);if(e.oncom){a.each(e.oncom.split(","),function(m,n){c.publish(n,e)})}}if(h&&e.resizable){h.resizable(c,e)}}if(h&&e.draggable){h.draggable(c,e)}if(h&&e.droppable){h.droppable(c,e)}if(h&&e.selectable){h.selectable(c,e)}if(h&&e.sortable){h.sortable(c,e)}if(e.onblurtopics){a.each(e.onblurtopics.split(","),function(n,m){c.blur(function(){k.publishTopic(c,m,{})})})}if(e.onfocustopics){a.each(e.onfocustopics.split(","),function(n,m){c.focus(function(){k.publishTopic(c,m,{})})})}if(e.oncha){if(e.type){if(e.type==="text"){c.keyup(function(){k.publishTopic(c,e.oncha,{})})}else{if(e.type==="select"){c.change(function(){k.publishTopic(c,e.oncha,{})});c.select(function(){k.publishTopic(c,e.onselecttopics,{})})}}}}},anchor:function(d,e){var c=this;c.log("anchor : "+e.id);if(e.onclick){a.each(e.onclick.split(","),function(g,f){d.publishOnEvent("click",f,e)})}if(e.opendialog){a.struts2_jquery_ui.opendialog(d,e)}if(e.button){a.struts2_jquery_ui.jquerybutton(d,e)}if((!e.href||e.href==="#")&&e.formids){var b="_s2j_form_topic_"+e.id;c.formsubmit(d,e,b)}else{c.action(d,e,c.handler.load,"a");if(e.targets&&(e.reloadtopic||e.listentopics)){a.each(e.targets.split(","),function(g,f){var h=a(c.escId(f));c.subscribeTopics(h,e.reloadtopics,c.handler.load,e);c.subscribeTopics(h,e.listentopics,c.handler.load,e)})}}},select:function(d,e){var c=this;c.log("select : "+e.id);if(!c.loadAtOnce){c.require("js/plugins/jquery.form"+c.minSuffix+".js")}var b="_s2j_topic_load_"+e.id;if(e.href&&e.href!=="#"){c.subscribeTopics(d,e.reloadtopics,c.handler.load,e);c.subscribeTopics(d,e.listentopics,c.handler.load,e);c.subscribeTopics(d,b,c.handler.load,e);if(!e.deferredloading){d.publish(b,e)}}if(e.oncha){a.each(e.oncha.split(","),function(f,g){d.publishOnEvent("change",g)})}if(e.autocomplete){if(!c.loadAtOnce){c.require(["js/base/jquery.ui.widget"+c.minSuffix+".js","js/base/jquery.ui.position"+c.minSuffix+".js","js/base/jquery.ui.button"+c.minSuffix+".js","js/base/jquery.ui.autocomplete"+c.minSuffix+".js"])}c.require(["js/plugins/jquery.combobox"+c.minSuffix+".js"]);d.combobox(e)}},button:function(d,j){var c=this;var b="_s2j_form_topic_"+j.id;j.preventAction=true;if(j.opendialog){a.struts2_jquery_ui.opendialog(d,j)}if(j.button){a.struts2_jquery_ui.jquerybutton(d,j)}if((!j.href||j.href==="#")&&j.formids!==undefined){c.formsubmit(d,j,b)}else{if(j.href&&j.href!=="#"){c.action(d,j,c.handler.load,"a");if(j.targets){a.each(j.targets.split(","),function(l,k){c.subscribeTopics(a(c.escId(k)),j.reloadtopics,c.handler.load,j);c.subscribeTopics(a(c.escId(k)),j.listentopics,c.handler.load,j)})}}else{var e=d.parents("form:first")[0];if(e!==undefined){var g=a(e);var f=g.attr("id");if(f!==undefined){j.formids=f}else{var h="s2jqform"+Math.floor(Math.random()*10000);g.attr("id",h);j.formids=h}c.formsubmit(d,j,b)}else{c.action(d,j,c.handler.load,"a");if(j.targets){a.each(j.targets.split(","),function(l,k){c.subscribeTopics(a(c.escId(k)),j.reloadtopics,c.handler.load,j);c.subscribeTopics(a(c.escId(k)),j.listentopics,c.handler.load,j)})}}}}if(j.onclick){a.each(j.onclick.split(","),function(l,k){d.publishOnEvent("click",k)})}d.removeAttr("name")},formsubmit:function(c,f,d){var b=this;f.actionTopic=d;b.log("formsubmit : "+f.id);if(!b.loadAtOnce){b.require("js/plugins/jquery.form"+b.minSuffix+".js")}if(f.targets){b.subscribeTopics(c,f.reloadtopics,b.handler.form,f);b.subscribeTopics(c,f.listentopics,b.handler.form,f);b.subscribeTopics(c,d,b.handler.form,f);a.each(f.targets.split(","),function(g,h){b.subscribeTopics(a(b.escId(h)),d,b.handler.effect,f);if(b.ajaxhistory){b.history(c,d,h)}});a.each(f.formids.split(","),function(g,h){a(b.escId(h)).bind("submit",function(j){j.preventDefault()})});c.click(function(){c.publish(d);return false})}else{c.click(function(j){var g=a(b.escId(f.formids));var h={};h.formvalidate=true;j.preventDefault();if(f.validate){h.formvalidate=b.validateForm(g,f);if(f.onaftervalidationtopics){a.each(f.onaftervalidationtopics.split(","),function(l,k){c.publish(k,elem,h)})}}if(h.formvalidate){g.submit()}return false});if(f.listentopics){var e={};e.formids=f.formids;e.validate=f.validate;c.subscribe(f.listentopics,function(j){var h=a(b.escId(j.data.formids));var k={};k.formvalidate=true;var g=true;if(j.data.validate){k.formvalidate=b.validateForm(h,f);a.each(f.onaftervalidationtopics.split(","),function(m,l){c.publish(l,elem,k)})}if(k.formvalidate){h.submit()}},e)}}},};a.subscribeHandler(a.struts2_jquery.handler.load,function(b,h){var f=a.struts2_jquery;var c=a(b.target);var e={};if(h){a.extend(e,h)}if(b.data){a.extend(e,b.data)}f.lasttopic=e.actionTopic;var m=false;m=e.disabled===null?m:e.disabled;m=c.prop("disabled");if(b.originalEvent){m=a(b.originalEvent.currentTarget).prop("disabled")}if(m!==true){if(e){var d=e.indicatorid;f.showIndicator(e.indicatorid);var l=e.onalw;var j="html";if(e.type){if(e.type==="text"){j="value"}else{if(e.type==="select"){j="select"}else{if(e.type==="checkbox"){j="checkbox"}else{if(e.type==="radio"){j="radio"}}}}}if(j==="html"||j==="value"){if(!e.datatype||e.datatype!=="json"){if(e.loadingtext&&e.loadingtext!=="false"){if(j==="html"){c.html(e.loadingtext)}else{c.val(e.loadingtext)}}else{if(f.defaults.loadingText!==null){if(j==="html"){c.html(f.defaults.loadingText)}else{c.val(f.defaults.loadingText)}}}}}var g={};g.success=f.pubSuc(b.target,l,e.onsuc,d,j,e);g.complete=f.pubCom(b.target,l,e.oncom,e.targets,d,e);g.error=f.pubErr(b.target,l,e.onerr,e.errortext,j);if(e.href){g.url=e.href;g.data="";if(e.hrefparameter){g.data=e.hrefparameter}if(e.requesttype){g.type=e.requesttype}else{g.type="POST"}if(e.formids&&g.data===""){if(!f.loadAtOnce){f.require("js/plugins/jquery.form"+f.minSuffix+".js")}a.each(e.formids.split(","),function(n,p){var o=a(f.escId(p)).formSerialize();if(g.data!==""){g.data=g.data+"&"+o}else{g.data=o}})}if(e.datatype){g.dataType=e.datatype}else{g.dataType="html"}if(!g.data){g.data={}}e.options=g;e.options.submit=true;f.publishTopic(c,l,e);f.publishTopic(c,e.onbef,e);if(e.options.submit){var k=c.attr("id");f.abortReq(k);f.currentXhr[k]=a.ajax(g)}}}}});a.subscribeHandler(a.struts2_jquery.handler.form,function(d,f){var e=a.struts2_jquery;var b=a(d.target);var c=b;var h={};if(f){a.extend(h,f)}if(d.data){a.extend(h,d.data)}e.lasttopic=h.actionTopic;var g={};if(h.href&&h.href!=="#"){g.url=h.href;if(h.hrefparameter){g.url=g.url+"?"+h.hrefparameter}}if(h.clearform){g.clearForm=true}if(h.iframe){g.iframe=true}if(h.resetform){g.resetForm=true}if(h.replaceTarget){g.replaceTarget=true}if(h.timeout){g.timeout=parseInt(h.timeout,10)}if(h.datatype){g.dataType=h.datatype}else{g.dataType=null}g.target="";if(h.targets){a.each(h.targets.split(","),function(k,l){c=a(e.escId(l));if(g.target===""){g.target=e.escId(l)}else{g.target=g.target+",#"+e.escId(l)}})}var j=h.indicatorid;g.beforeSubmit=function(n,l,k){var m={};m.formData=n;m.form=l;m.options=k;m.options.submit=true;e.publishTopic(b,h.onalw,m);if(h.onbef){a.each(h.onbef.split(","),function(q,p){c.publish(p,c,m);var o=m.options.submit})}if(h.validate){m.options.submit=e.validateForm(l,h);m.formvalidate=m.options.submit;if(h.onaftervalidationtopics){a.each(h.onaftervalidationtopics.split(","),function(p,o){c.publish(o,c,m)})}}if(m.options.submit){e.showIndicator(j);if(!h.datatype||h.datatype!=="json"){if(h.loadingtext&&h.loadingtext!=="false"){a.each(h.targets.split(","),function(o,p){a(e.escId(p)).html(h.loadingtext)})}else{if(e.defaults.loadingText!==null){a.each(h.targets.split(","),function(o,p){a(e.escId(p)).html(e.defaults.loadingText)})}}}}return m.options.submit};g.success=e.pubSuc(c,h.onalw,h.onsuc,j,"form",h);g.complete=e.pubCom(c,h.onalw,h.oncom,h.targets,j,h);g.error=e.pubErr(c,h.onalw,h.onerr,h.errortext,"html");a.each(h.formids.split(","),function(k,l){e.log("submit form : "+l);a(e.escId(l)).ajaxSubmit(g)});return false});a.subscribeHandler(a.struts2_jquery.handler.effect,function(d,f){var e=a.struts2_jquery;var h={};a.extend(h,d.data);if(h.targets&&h.effect){var c={};var g=2000;if(h.effectoptions){c=h.effectoptions}if(h.effectduration){g=h.effectduration}var j;var b=a(e.escId(h.targets));if(h.oneffect){a.subscribe(b,h.oneffect,h);j=function(){e.publishTopic(b,h.oneffect,h)}}if(!e.loadAtOnce){e.require(["js/base/jquery.effects.core"+e.minSuffix+".js","js/base/jquery.effects."+h.effect+e.minSuffix+".js"])}e.log("effect "+h.effect+" for "+h.targets);if(!h.effectmode||h.effectmode==="none"){b.effect(h.effect,c,g,j)}else{if(h.effectmode==="show"){b.show(h.effect,c,g,j)}else{if(h.effectmode==="hide"){b.hide(h.effect,c,g,j)}else{if(h.effectmode==="toggle"){b.toggle(h.effect,c,g,j)}}}}}})})(jQuery);